# ğŸ¨ Phase 2 Visual Guide - Routing Engine Data Flow

## ğŸ“Š The Two-Level Split Architecture

```
                           SwapArgs
                               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚                      â”‚
    amount_in           expect_amount_out        min_return
    (input)              (expected)              (slippage)
        â”‚                                             â”‚
        â”‚                                             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º amounts â—„â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”    â”‚
                    â”‚             â”‚    â”‚
                [Path 0]      [Path 1] â”‚
                 300 USDC      700 USDCâ”‚
                    â”‚             â”‚    â”‚
                    â”‚             â”‚    â”‚
              LEVEL 1 SPLIT       â”‚    â”‚
              (Parallel Paths)    â”‚    â”‚
                    â”‚             â”‚    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”     â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”
        â”‚               â”‚     â”‚            â”‚
    routes[0]      routes[1]  â”‚      routes[n]
        â”‚               â”‚     â”‚            â”‚
        â”‚               â”‚     â”‚            â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”‚
   â”‚         â”‚     â”‚     â”‚    â”‚    â”‚   â”‚
 Hop 0     Hop 1  Hop 0 Hop 1 Hop 2  ...
   â”‚         â”‚     â”‚     â”‚    â”‚
   â”‚         â”‚     â”‚     â”‚    â”‚
LEVEL 2 SPLITâ”‚     â”‚     â”‚    â”‚
(Multi-Hop) â”‚      â”‚     â”‚    â”‚
   â”‚         â”‚     â”‚     â”‚    â”‚
â”Œâ”€â”€â”´â”€â”€â”   â”Œâ”€â”€â”´â”€â”€â” â”‚     â”‚    â”‚
â”‚     â”‚   â”‚     â”‚ â”‚     â”‚    â”‚
DEX0 DEX1 DEX0 DEX1     ...  ...
50%  50%  60%  40%

LEVEL 3: DEX SPLITS
(Weight-based routing per hop)
```

## ğŸ”„ Execution Flow: Step-by-Step

### Example: 1000 USDC â†’ BONK (2 paths, multi-hop)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INPUT: 1000 USDC                                            â”‚
â”‚ SwapArgs {                                                  â”‚
â”‚   amount_in: 1000 USDC                                      â”‚
â”‚   amounts: [300, 700]  â† Level 1 split                      â”‚
â”‚   routes: [                                                 â”‚
â”‚     [Route{...}],      â† Path 0: 1 hop                      â”‚
â”‚     [Route{...}, Route{...}] â† Path 1: 2 hops               â”‚
â”‚   ]                                                         â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚         Level 1 Split          â”‚
              â”‚    (Parallel Routing Paths)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                            â”‚
        â”‚                                            â”‚
   Path 0 (300 USDC)                          Path 1 (700 USDC)
        â”‚                                            â”‚
        â”‚                                            â”‚
  â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Hop 0   â”‚                              â”‚    Hop 0     â”‚
  â”‚ USDCâ†’BONK â”‚                              â”‚   USDCâ†’SOL   â”‚
  â”‚  (Direct) â”‚                              â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                           â”‚
        â”‚ Level 2 Split                             â”‚ Level 2 Split
        â”‚ (DEX weights)                             â”‚ (DEX weights)
        â”‚                                           â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                             â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    60%   â”‚ 40%                          â”‚ 50%   30%   â”‚  20%  â”‚
   â”‚          â”‚                              â”‚             â”‚       â”‚
Raydium   Whirlpool                      Raydium    Whirlpool  Meteora
180 USDC  120 USDC                       350 USDC   210 USDC  140 USDC
   â”‚          â”‚                              â”‚             â”‚       â”‚
   â”‚          â”‚                              â”‚             â”‚       â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                           â”‚
   ~15k BONK                                    ~0.07 SOL
        â”‚                                           â”‚
        â”‚                                           â”‚
        â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                    â”‚    Hop 1     â”‚
        â”‚                                    â”‚   SOLâ†’BONK   â”‚
        â”‚                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                           â”‚
        â”‚                                     Level 2 Split
        â”‚                                           â”‚
        â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                    â”‚     100%     â”‚
        â”‚                                  Raydium
        â”‚                                  0.07 SOL
        â”‚                                    â”‚
        â”‚                                 ~35k BONK
        â”‚                                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                    Final Output
                   ~50,000 BONK
                          â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ Slippage Check:  â”‚
                 â”‚ 50k >= 49k âœ…    â”‚
                 â”‚ (min_return)     â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ Data Structure Breakdown

### 1. Dex Enum - The Building Blocks

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Dex Enum                         â”‚
â”‚                   (67 variants)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   AMM DEXs   â”‚  â”‚  CLMM DEXs   â”‚  â”‚OrderBook â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ Raydium      â”‚  â”‚ Whirlpool    â”‚  â”‚ OpenBook â”‚ â”‚
â”‚  â”‚ Meteora      â”‚  â”‚ RaydiumCLMM  â”‚  â”‚ Phoenix  â”‚ â”‚
â”‚  â”‚ Lifinity     â”‚  â”‚ MeteoraDLMM  â”‚  â”‚ Manifest â”‚ â”‚
â”‚  â”‚ FluxBeam     â”‚  â”‚ Byreal       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Specialized  â”‚  â”‚ Meme Tokens  â”‚  â”‚   LST    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ StableSwap   â”‚  â”‚ Pumpfun      â”‚  â”‚ Sanctum  â”‚ â”‚
â”‚  â”‚ SanctumRouterâ”‚  â”‚ Boopfun      â”‚  â”‚MeteoraLstâ”‚ â”‚
â”‚  â”‚ Perpetuals   â”‚  â”‚ Virtuals     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Route Structure - DEX Path + Weights

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Route                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  dexes: Vec<Dex>                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ DEX0 â”‚ DEX1 â”‚ DEX2 â”‚                  â”‚
â”‚  â””â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”˜                  â”‚
â”‚     â”‚      â”‚      â”‚                       â”‚
â”‚  weights: Vec<u8>                         â”‚
â”‚  â”Œâ”€â”€â”´â”€â”€â”€â”¬â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”´â”€â”€â”€â”                  â”‚
â”‚  â”‚  50  â”‚  30  â”‚  20  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                            â”‚
â”‚  âš ï¸  Constraints:                          â”‚
â”‚  â€¢ dexes.len() == weights.len()           â”‚
â”‚  â€¢ sum(weights) == 100                    â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. SwapArgs - The Complete Picture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SwapArgs                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  amount_in: u64           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ Slippage Zone  â”‚         â”‚
â”‚  â”‚  1000 USDC      â”‚      â”‚                 â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ expect: 50k â”€â”€â”€â”€â”¼â”€â”       â”‚
â”‚                           â”‚                 â”‚ â”‚       â”‚
â”‚  expect_amount_out: u64   â”‚ min:    49k â”€â”€â”€â”€â”¼â”€â”¤ 2%    â”‚
â”‚  min_return: u64          â”‚                 â”‚ â”‚       â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚
â”‚                                          â–²â”€â”€â”€â”€â”˜       â”‚
â”‚  amounts: Vec<u64>                       â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”                   Tolerance         â”‚
â”‚  â”‚300 â”‚700 â”‚... â”‚  â† Must sum to amount_in            â”‚
â”‚  â””â”€â”¬â”€â”€â”´â”€â”¬â”€â”€â”´â”€â”¬â”€â”€â”˜                                     â”‚
â”‚    â”‚    â”‚    â”‚                                        â”‚
â”‚  routes: Vec<Vec<Route>>                              â”‚
â”‚    â”‚    â”‚    â”‚                                        â”‚
â”‚  â”Œâ”€â”´â”€â”€â”¬â”€â”´â”€â”€â”¬â”€â”´â”€â”€â”                                     â”‚
â”‚  â”‚ [] â”‚ [] â”‚ [] â”‚  â† Each is a Vec<Route> (hops)      â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                        â”‚
â”‚  âš ï¸  Constraints:                                      â”‚
â”‚  â€¢ amounts.len() == routes.len()                      â”‚
â”‚  â€¢ sum(amounts) == amount_in                          â”‚
â”‚  â€¢ expect_amount_out >= min_return                    â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. HopAccounts - Multi-Hop Token Flow

```
Swap Path: USDC â†’ SOL â†’ RAY â†’ BONK
           â”œâ”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”¤ â”œâ”€â”€â”€â”¤
           Hop 0 Hop 1 Hop 2

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hop 0: USDC â†’ SOL                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ HopAccounts {                                â”‚   â”‚
â”‚ â”‚   last_to_account: 0x000... (none)          â”‚   â”‚
â”‚ â”‚   from_account:    User's USDC account â”€â”€â”€â”€â”€â”¼â”€â”€â”â”‚
â”‚ â”‚   to_account:      Intermediate SOL acct â”€â”€â”€â”¼â”€â”â”‚â”‚
â”‚ â”‚ }                                            â”‚ â”‚â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”¼â”˜
                                                  â”‚â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”¼â”
â”‚ Hop 1: SOL â†’ RAY                                â”‚â”‚â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚â”‚
â”‚ â”‚ HopAccounts {                                â”‚ â”‚â”‚â”‚
â”‚ â”‚   last_to_account: Intermediate SOL acct â—„â”€â”€â”¼â”€â”˜â”‚â”‚
â”‚ â”‚   from_account:    Intermediate SOL acct â—„â”€â”€â”¼â”€â”€â”˜â”‚
â”‚ â”‚   to_account:      Intermediate RAY acct â”€â”€â”€â”¼â”€â” â”‚
â”‚ â”‚ }                                            â”‚ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”˜
                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”
â”‚ Hop 2: RAY â†’ BONK                               â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ HopAccounts {                                â”‚ â”‚ â”‚
â”‚ â”‚   last_to_account: Intermediate RAY acct â—„â”€â”€â”¼â”€â”˜ â”‚
â”‚ â”‚   from_account:    Intermediate RAY acct â—„â”€â”€â”¼â”€â”€â”€â”˜
â”‚ â”‚   to_account:      User's BONK account â”€â”€â”€â”€â”€â”¼â”€â”€â”
â”‚ â”‚ }                                            â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”˜
                                                   â”‚
                                    âœ… Validated: â”‚
                                    Must match user's
                                    destination account
```

## ğŸ”¢ Weight Calculation Algorithm

### How 2nd Level Splits Are Calculated

```rust
// Given:
amount_in = 1000 USDC
weights = [50, 30, 20]
dexes = [Raydium, Whirlpool, Meteora]

// Calculation:
for each DEX (except last):
    fork_amount = (amount_in * weight) / 100
    
// Last DEX gets remainder (prevents rounding errors):
last_amount = amount_in - sum(previous_forks)

// Result:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DEX 0 (Raydium):                        â”‚
â”‚   1000 * 50 / 100 = 500 USDC           â”‚
â”‚   acc_fork_in = 500                     â”‚
â”‚                                         â”‚
â”‚ DEX 1 (Whirlpool):                      â”‚
â”‚   1000 * 30 / 100 = 300 USDC           â”‚
â”‚   acc_fork_in = 800                     â”‚
â”‚                                         â”‚
â”‚ DEX 2 (Meteora) - LAST:                 â”‚
â”‚   1000 - 800 = 200 USDC âœ…             â”‚
â”‚   (not 1000 * 20 / 100 to avoid error) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Checkpoint Solution Visualized

### Scenario: 1000 USDC â†’ BONK (2-hop, 3-DEX)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SwapArgs Construction                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ amount_in: 1,000,000,000  (1000 USDC)                   â”‚
â”‚                                                          â”‚
â”‚ amounts: [1,000,000,000]                                â”‚
â”‚           â””â”€ Only 1 path, all input goes here           â”‚
â”‚                                                          â”‚
â”‚ routes: [                                                â”‚
â”‚   [                    â† Path 0 (hops array)            â”‚
â”‚     Route {            â† Hop 0: USDC â†’ SOL              â”‚
â”‚       dexes: [                                           â”‚
â”‚         Dex::RaydiumSwap,        â† 500 USDC (50%)       â”‚
â”‚         Dex::Whirlpool,          â† 300 USDC (30%)       â”‚
â”‚         Dex::MeteoraDynamicpool  â† 200 USDC (20%)       â”‚
â”‚       ],                                                 â”‚
â”‚       weights: [50, 30, 20]  â† Must sum to 100          â”‚
â”‚     },                                                   â”‚
â”‚                                                          â”‚
â”‚     Route {            â† Hop 1: SOL â†’ BONK              â”‚
â”‚       dexes: [                                           â”‚
â”‚         Dex::RaydiumSwap  â† All SOL from hop 0          â”‚
â”‚       ],                                                 â”‚
â”‚       weights: [100]       â† 100% through Raydium       â”‚
â”‚     }                                                    â”‚
â”‚   ]                                                      â”‚
â”‚ ]                                                        â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Execution Flow:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1000 USDC (input)
    â”‚
    â”œâ”€ amounts[0] = 1000 USDC (100% to Path 0)
    â”‚
    â””â”€ Path 0:
        â”‚
        â”œâ”€ Hop 0 (USDC â†’ SOL):
        â”‚   â”‚
        â”‚   â”œâ”€ Raydium:  500 USDC (50%) â†’ 0.05 SOL
        â”‚   â”œâ”€ Whirlpool: 300 USDC (30%) â†’ 0.03 SOL
        â”‚   â””â”€ Meteora:   200 USDC (20%) â†’ 0.02 SOL
        â”‚   â”‚
        â”‚   â””â”€ Combined: 0.1 SOL
        â”‚
        â””â”€ Hop 1 (SOL â†’ BONK):
            â”‚
            â””â”€ Raydium: 0.1 SOL (100%) â†’ 50,000 BONK
            
Final Output: 50,000 BONK âœ… (>= min_return: 49,000)
```

## ğŸ“ Common Patterns

### Pattern 1: Simple Direct Swap
```
Input â†’ [1 DEX] â†’ Output
```

### Pattern 2: Split Liquidity (Same Hop)
```
Input â†’ [DEX1 (60%)] â”
     â†’ [DEX2 (40%)] â”´â†’ Output
```

### Pattern 3: Multi-Hop (Sequential)
```
Input â†’ [DEX1] â†’ Intermediate1 â†’ [DEX2] â†’ Output
```

### Pattern 4: Multi-Hop with Splits
```
Input â†’ [DEX1 (50%)] â”
     â†’ [DEX2 (50%)] â”´â†’ Int â†’ [DEX3] â†’ Output
```

### Pattern 5: Multi-Path (Parallel Routes)
```
Input â†’ Path A (30%): [DEX1] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â†’ Path B (70%): [DEX2] â†’ [DEX3] â†’ Output
```

### Pattern 6: Complex (Everything Combined)
```
Input â†’ Path A (40%): [DEX1 (60%)] â”     â”
                   â†’ [DEX2 (40%)] â”´â†’ Out â”¤
     â†’ Path B (60%): [DEX3] â†’ [DEX4 (50%)] â”  â”¤â†’ Final
                            â†’ [DEX5 (50%)] â”´â†’ Out â”˜
```

## ğŸ§ª Validation Checklist

When constructing `SwapArgs`, verify:

```
âœ… amounts.len() == routes.len()
âœ… sum(amounts) == amount_in
âœ… expect_amount_out >= min_return

For each Route:
  âœ… dexes.len() == weights.len()
  âœ… sum(weights) == 100
  âœ… Each weight > 0

For HopAccounts (runtime):
  âœ… First hop: from_account == user_source_account
  âœ… Last hop:  to_account == user_destination_account
  âœ… Between hops: current.from == previous.to
```

## ğŸš€ Performance Considerations

### Trade-offs in Route Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Route Type      â”‚ Gas Cost â”‚ Complexity â”‚ Price    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Single DEX      â”‚   LOW    â”‚    LOW     â”‚   OK     â”‚
â”‚ 2-DEX Split     â”‚   MED    â”‚    MED     â”‚  BETTER  â”‚
â”‚ 3-DEX Split     â”‚   HIGH   â”‚    HIGH    â”‚   BEST   â”‚
â”‚ Multi-Hop       â”‚  +HIGH   â”‚   +HIGH    â”‚  VARIED  â”‚
â”‚ Multi-Path      â”‚ ++HIGH   â”‚  ++HIGH    â”‚ OPTIMAL  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Rule of Thumb:
  More splits  = Better price, Higher gas
  More hops    = Access to more pairs
  More paths   = Maximum optimization, Maximum cost
```

## ğŸ“ Key Takeaways

1. **Two-Level Architecture**: Level 1 (parallel paths) + Level 2 (multi-hop with DEX splits)

2. **Weights are Percentages**: Always sum to 100, last DEX gets remainder

3. **HopAccounts Chains**: Each hop's `to_account` becomes next hop's `from_account`

4. **Slippage Protection**: `min_return` is your safety net

5. **Flexibility**: Can represent simple 1-DEX swaps to complex 4-path, 3-hop, multi-DEX routes

---

**ğŸ† You're now ready to design and understand complex swap routes!**

