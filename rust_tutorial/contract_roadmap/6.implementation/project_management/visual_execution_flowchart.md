# ðŸŽ¨ DEX Router Execution Flow - Visual Flowchart

## ðŸ“ Complete Execution Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     USER INITIATES SWAP                         â”‚
â”‚                  swap_handler(SwapArgs)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      VALIDATION PHASE                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ âœ“ amounts.len() == routes.len()                          â”‚  â”‚
â”‚  â”‚ âœ“ sum(amounts) == amount_in                              â”‚  â”‚
â”‚  â”‚ âœ“ expect_amount_out >= min_return                        â”‚  â”‚
â”‚  â”‚ âœ“ min_return > 0                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LEVEL 1: ROUTE SPLITTING LOOP                      â”‚
â”‚              for (i, hops) in routes.iter().enumerate()         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Route 0: amount_in = amounts[0]                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  MULTI-HOP LOOP                                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  for (hop, route) in hops.iter().enumerate()         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Hop 0: Route { dexes, weights }              â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  LEVEL 2: DEX WEIGHT SPLIT              â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  for (index, dex) in dexes.enumerate()  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  DEX 0: Calculate fork_amount_in  â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  - If last: use remainder         â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  - Else: amount Ã— weight / 100    â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚              â–¼                           â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  distribute_swap(dex, ...)        â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  Match DEX type:            â”‚  â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  - RaydiumSwap â†’ raydium::  â”‚  â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  - Whirlpool â†’ whirlpool::  â”‚  â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  - OpenBookV2 â†’ openbook::  â”‚  â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  - ... (67 DEXs total)      â”‚  â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚                                   â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  Returns: fork_amount_out        â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚              â–¼                           â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  emit!(SwapEvent)                 â”‚  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚                                          â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  Repeat for each DEX in route.dexes    â”‚  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                                 â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Hop Output = sum(all fork_amount_out)         â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Repeat for each hop, using previous output as next    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  hop's input (amount_in = amount_out)                  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Validation:                                                 â”‚ â”‚
â”‚  â”‚  - First hop: from_account == user_source_account           â”‚ â”‚
â”‚  â”‚  - Last hop: to_account == user_destination_account         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  Repeat for each route in routes                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FINAL VALIDATION                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Reload destination account                               â”‚  â”‚
â”‚  â”‚  actual_output = after_balance - before_balance           â”‚  â”‚
â”‚  â”‚  require!(actual_output >= min_return)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ SUCCESS â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ Level 1 vs Level 2 Split Comparison

### Level 1: Route-Level Split (Parallel Paths)

```
Total Input: 1000 USDC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      amounts = [600, 400]          â”‚
â”‚      routes.len() = 2              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
  600 USDC         400 USDC
  Route 0          Route 1
    â”‚                 â”‚
    â–¼                 â–¼
[Executes          [Executes
independently]     independently]
    â”‚                 â”‚
    â–¼                 â–¼
 Output A          Output B
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    Total: A + B
```

**Key Characteristics:**
- Parallel execution paths
- Different hop structures allowed
- Amount split decided upfront
- Each route gets fixed input amount

### Level 2: DEX-Level Split (Weight Distribution)

```
Route Input: 600 USDC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Route {                           â”‚
â”‚    dexes = [Raydium, Whirlpool,    â”‚
â”‚             Meteora]               â”‚
â”‚    weights = [50, 30, 20]          â”‚
â”‚  }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        â”‚        â”‚
  300 USDC  180 USDC 120 USDC
  (50%)     (30%)    (20%)
    â”‚        â”‚        â”‚
    â–¼        â–¼        â–¼
 Raydium  Whirlpool Meteora
    â”‚        â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      Total Output
```

**Key Characteristics:**
- Sequential weight-based split within a hop
- All DEXs execute same token pair
- Weights must sum to 100
- Last DEX uses remainder

---

## ðŸŽ¯ Example: Complex 3-Route Swap Flow

```
Input: 1000 USDC â†’ BONK
Expected: ~50,000 BONK
Min Return: 49,000 BONK (2% slippage)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              1000 USDC Total Input                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                â”‚                    
        â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚    â”‚           â”‚       â”‚              â”‚
     300 USDC    400 USDC 300 USDC  
     (30%)       (40%)    (30%)      
     Route 0     Route 1  Route 2    
        â”‚           â”‚        â”‚       

â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚ Direct Path    â”‚  â”‚  â”‚Multi-Hop  â”‚
â”‚                â”‚  â”‚  â”‚           â”‚
â”‚ Hop 0:         â”‚  â”‚  â”‚Hop 0:     â”‚
â”‚ USDC â†’ BONK    â”‚  â”‚  â”‚USDCâ†’SOL   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Raydium  â”‚   â”‚  â”‚  â”‚â”‚Whirlpoolâ”‚
â”‚ â”‚  100%    â”‚   â”‚  â”‚  â”‚â”‚  60%   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      â”‚         â”‚  â”‚  â”‚    â”‚      â”‚
â”‚      â–¼         â”‚  â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ ~14,800 BONK   â”‚  â”‚  â”‚â”‚Meteora â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚â”‚  40%   â”‚ â”‚
                    â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚  â”‚    â”‚      â”‚
                    â”‚  â”‚Hop 1:     â”‚
                    â”‚  â”‚SOL â†’ BONK â”‚
                    â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚  â”‚â”‚Raydium â”‚ â”‚
                    â”‚  â”‚â”‚  100%  â”‚ â”‚
                    â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚  â”‚    â”‚      â”‚
                    â”‚  â”‚    â–¼      â”‚
                    â”‚  â”‚~19,600BONKâ”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
              â”‚Split Path  â”‚
              â”‚            â”‚
              â”‚Hop 0:      â”‚
              â”‚USDC â†’ BONK â”‚
              â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
              â”‚â”‚Raydium  â”‚ â”‚
              â”‚â”‚  70%    â”‚ â”‚
              â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
              â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
              â”‚â”‚Whirlpoolâ”‚ â”‚
              â”‚â”‚  30%    â”‚ â”‚
              â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
              â”‚     â”‚      â”‚
              â”‚     â–¼      â”‚
              â”‚~14,800BONK â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚              â”‚              â”‚
â”‚ ~14,800 BONK â”‚ ~19,600 BONK â”‚ ~14,800 BONK â”‚
â”‚              â”‚              â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ~49,200 BONK  â”‚
              â”‚ >= 49,000 âœ…  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ” Weight Calculation Deep Dive

### Standard Weight Calculation (Non-Last DEX)

```
Given:
  amount_in = 600 USDC
  weights = [50, 30, 20]
  TOTAL_WEIGHT = 100

For DEX 0 (index = 0, not last):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fork_amount_in = amount_in          â”‚
â”‚                  Ã— weights[0]       â”‚
â”‚                  Ã· TOTAL_WEIGHT     â”‚
â”‚                                     â”‚
â”‚                = 600 Ã— 50 Ã· 100     â”‚
â”‚                = 300                â”‚
â”‚                                     â”‚
â”‚ acc_fork_in += fork_amount_in       â”‚
â”‚              = 0 + 300 = 300        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

For DEX 1 (index = 1, not last):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fork_amount_in = 600 Ã— 30 Ã· 100     â”‚
â”‚                = 180                â”‚
â”‚                                     â”‚
â”‚ acc_fork_in += 180                  â”‚
â”‚              = 300 + 180 = 480      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

For DEX 2 (index = 2, LAST):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fork_amount_in = amount_in          â”‚
â”‚                  - acc_fork_in      â”‚
â”‚                                     â”‚
â”‚                = 600 - 480          â”‚
â”‚                = 120                â”‚
â”‚                                     â”‚
â”‚ (No update to acc_fork_in)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Verification:
  300 + 180 + 120 = 600 âœ…
```

### Why Remainder for Last DEX?

```
âŒ Wrong Approach (Calculate All):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DEX 0: 600 Ã— 50 Ã· 100 = 300.000     â”‚
â”‚ DEX 1: 600 Ã— 30 Ã· 100 = 180.000     â”‚
â”‚ DEX 2: 600 Ã— 20 Ã· 100 = 120.000     â”‚
â”‚                                     â”‚
â”‚ Total: 300 + 180 + 120 = 600        â”‚
â”‚ Looks fine, but...                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Problem with integer division:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Example: 1000 Ã· 3                   â”‚
â”‚ weights = [33, 33, 34]              â”‚
â”‚                                     â”‚
â”‚ DEX 0: 1000 Ã— 33 Ã· 100 = 330        â”‚
â”‚ DEX 1: 1000 Ã— 33 Ã· 100 = 330        â”‚
â”‚ DEX 2: 1000 Ã— 34 Ã· 100 = 340        â”‚
â”‚                                     â”‚
â”‚ Sum: 330 + 330 + 340 = 1000         â”‚
â”‚ BUT if all calculated same way:     â”‚
â”‚ Rounding could cause 999 or 1001!   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Correct Approach (Remainder):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DEX 0: 1000 Ã— 33 Ã· 100 = 330        â”‚
â”‚   acc = 330                         â”‚
â”‚                                     â”‚
â”‚ DEX 1: 1000 Ã— 33 Ã· 100 = 330        â”‚
â”‚   acc = 330 + 330 = 660             â”‚
â”‚                                     â”‚
â”‚ DEX 2: 1000 - 660 = 340 (exact!)    â”‚
â”‚                                     â”‚
â”‚ Guaranteed: 330 + 330 + 340 = 1000  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”— Multi-Hop Account Chain

### 3-Hop Example: USDC â†’ SOL â†’ RAY â†’ BONK

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      HOP 0: USDC â†’ SOL                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  HopAccounts {                                             â”‚
â”‚    last_to_account: 0x000...000 (none)                     â”‚
â”‚    from_account:    user_usdc_account â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    to_account:      intermediate_sol_account â”‚             â”‚
â”‚  }                                           â”‚             â”‚
â”‚                                              â”‚             â”‚
â”‚  âœ… Validation: from_account == user_source  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â”‚ Output: 0.1 SOL
                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      HOP 1: SOL â†’ RAY        â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  amount_in = 0.1 SOL (from hop 0 output)     â”‚             â”‚
â”‚                                              â”‚             â”‚
â”‚  HopAccounts {                               â”‚             â”‚
â”‚    last_to_account: intermediate_sol_account â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    from_account:    intermediate_sol_account â”€â”€â”
â”‚    to_account:      intermediate_ray_account   â”‚
â”‚  }                                             â”‚
â”‚                                                â”‚
â”‚  âœ… Implicit validation: from == last_to       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â”‚ Output: 5 RAY
                                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      HOP 2: RAY â†’ BONK         â”‚           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  amount_in = 5 RAY (from hop 1 output)         â”‚           â”‚
â”‚                                                â”‚           â”‚
â”‚  HopAccounts {                                 â”‚           â”‚
â”‚    last_to_account: intermediate_ray_account â—„â”€â”˜
â”‚    from_account:    intermediate_ray_account â”€â”€â”
â”‚    to_account:      user_bonk_account          â”‚
â”‚  }                                             â”‚
â”‚                                                â”‚
â”‚  âœ… Validation: to_account == user_destination â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Validation Points:**
- âœ… Hop 0 (first): `from_account` validated against user's source
- âš™ï¸ Hop 1 (middle): Implicit validation through `last_to_account` tracking
- âœ… Hop 2 (last): `to_account` validated against user's destination

---

## ðŸ“Š Event Emission Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Swap Execution Timeline                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º

Route 0, Hop 0, DEX 0 (Raydium):
  â”‚
  â”œâ”€â–º Execute: raydium::swap(300 USDC)
  â”‚             â””â”€â–º Returns: 0.03 SOL
  â”‚
  â””â”€â–º Emit: SwapEvent {
        dex: Dex::RaydiumSwap,
        amount_in: 300_000_000,
        amount_out: 30_000_000,
      }

Route 0, Hop 0, DEX 1 (Whirlpool):
  â”‚
  â”œâ”€â–º Execute: whirlpool::swap(300 USDC)
  â”‚             â””â”€â–º Returns: 0.031 SOL
  â”‚
  â””â”€â–º Emit: SwapEvent {
        dex: Dex::Whirlpool,
        amount_in: 300_000_000,
        amount_out: 31_000_000,
      }

Route 0, Hop 1, DEX 0 (Meteora):
  â”‚
  â”œâ”€â–º Execute: meteora::swap(0.061 SOL)
  â”‚             â””â”€â–º Returns: 30,000 BONK
  â”‚
  â””â”€â–º Emit: SwapEvent {
        dex: Dex::MeteoraDynamicpool,
        amount_in: 61_000_000,
        amount_out: 30_000_000_000,
      }

... (Continue for all routes, hops, and DEXs)

Final Validation:
  â”‚
  â”œâ”€â–º Reload destination account
  â”‚
  â”œâ”€â–º Calculate: total_out = 50_000 BONK
  â”‚
  â””â”€â–º require!(50_000 >= min_return(49,000)) âœ…
```

---

## ðŸŽ“ Quick Reference: Code Line Numbers

| Component | File | Lines | Purpose |
|-----------|------|-------|---------|
| Entry Point | `swap.rs` | ~20-40 | User-facing swap instruction |
| Validation | `common_swap.rs` | 451-476 | SwapArgs validation |
| Level 1 Loop | `common_swap.rs` | 481-572 | Route iteration |
| Level 2 Loop | `common_swap.rs` | 507-553 | DEX weight split |
| Weight Calc | `common_swap.rs` | 509-524 | Fork amount calculation |
| DEX Dispatch | `common_swap.rs` | 582-702 | Match DEX to adapter |
| Hop Validation | `common_swap.rs` | 555-568 | Account continuity |
| Final Check | `common_swap.rs` | 430-435 | Min return validation |

---

**ðŸ’¡ Pro Tip**: Print this flowchart and keep it next to you while reading the code!

