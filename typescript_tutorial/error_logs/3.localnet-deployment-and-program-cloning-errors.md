# Solana 本地网络部署与程序克隆错误 - 学习复盘文档

## 概述
本文档记录了在 Solana DEX Router 项目中，使用本地测试网络（localnet）部署程序和测试 swap 功能时遇到的两个关键错误。通过这次调试过程，深入理解了 Solana 程序部署的状态管理机制以及 mainnet 程序克隆的正确方法。

---

## 错误1：程序部署失败 - 可执行账户数据变更错误

### 背景
在修复代码后，尝试使用 `anchor localnet` 命令启动本地验证器，然后使用 `anchor deploy` 部署 DEX Router 程序到本地测试网络。

### 错误
```
Error: Error processing Instruction 0: instruction changed executable accounts data
There was a problem deploying: Output { status: ExitStatus(unix_wait_status(256)), stdout: "", stderr: "" }.
```

部署过程中出现错误，提示指令尝试修改可执行账户的数据。

### 原因
1. **验证器状态陈旧**：本地 Solana 测试验证器保留了之前部署的程序账户数据和状态
2. **账户状态冲突**：当程序被修改重新构建后，新程序的大小或内部结构可能发生变化，但验证器账本（ledger）中仍保留旧的账户状态
3. **部署冲突**：Solana 的安全机制检测到尝试修改已存在的可执行账户数据，拒绝了部署操作
4. **不完整的清理**：虽然使用了 `anchor localnet`，但之前的 `.anchor` 目录和缓存数据未被清理

### 方案

**完整的环境清理和重新部署流程**：

```bash
# 步骤1：强制终止所有验证器进程
pkill -9 -f solana-test-validator

# 步骤2：彻底清理所有缓存和账本数据
cd /root/DEX-Router-Solana-V1
rm -rf .anchor test-ledger
anchor clean

# 步骤3：重新构建程序
anchor build

# 步骤4：验证程序 ID 一致性
solana-keygen pubkey target/deploy/dex_solana-keypair.json
# 确认与 Anchor.toml 和 lib.rs 中的 declare_id! 一致

# 步骤5：创建 ledger 目录并启动验证器
mkdir -p .anchor/test-ledger
nohup solana-test-validator --reset \
  --ledger .anchor/test-ledger \
  --bind-address 0.0.0.0 \
  --rpc-port 8899 \
  --url https://api.mainnet-beta.solana.com \
  --clone So11111111111111111111111111111111111111112 \
  --clone EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v \
  # ... 其他需要克隆的账户
  > validator.log 2>&1 &

# 步骤6：等待验证器完全启动
sleep 20

# 步骤7：验证验证器状态
ps aux | grep solana-test-validator
tail -20 validator.log

# 步骤8：部署程序
anchor deploy
```

**部署成功输出**：
```
Deploying cluster: http://0.0.0.0:8899
Upgrade authority: /root/.config/solana/id.json
Deploying program "dex_solana"...
Program path: /root/DEX-Router-Solana-V1/target/deploy/dex_solana.so...
Program Id: Bv3yUnYUUp9HX6Wzum4632t4PGs2S5rBXEoG4jwsYTxM

Deploy success
```

**关键学习点**：
- 部署错误通常与验证器状态冲突有关，需要完全重置环境
- `--reset` 参数对于确保干净的验证器状态至关重要
- 清理操作要彻底：停止进程 → 删除缓存 → 清理构建产物 → 重新开始
- 手动启动验证器时需要添加 `--url` 参数才能使用 `--clone` 功能

---

## 错误2：测试失败 - Raydium 程序未部署错误

### 背景
程序成功部署后，运行 `npm run test:swap` 测试 SOL 到 USDC 的 swap 功能。测试代码配置了所有必要的账户，包括 Raydium AMM 程序和相关的池账户，并在 `Anchor.toml` 中配置了需要克隆的 mainnet 账户。

### 错误
```
❌ Swap execution failed: Simulation failed. 
Message: Transaction simulation failed: Error processing Instruction 0: invalid account data for instruction. 
Logs: 
[
  "Program log: Dex::RaydiumSwap amount_in: 100000000, offset: 0",
  "Program 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8 invoke [2]",
  "Program is not deployed",
  "Program 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8 failed: invalid account data for instruction"
]
```

测试在调用 Raydium swap 时失败，提示 Raydium 程序（`675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8`）未部署。

### 原因

**根本原因**：错误地使用了 `--clone` 参数来克隆 Raydium 程序。

**深层分析**：

1. **`--clone` 只克隆账户元数据**：
   - 使用 `--clone 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8` 只克隆了程序账户本身（36 字节）
   - 这个账户包含指向实际程序数据的指针，但不包含可执行代码
   
2. **程序数据存储在单独的账户**：
   - Solana 的可升级程序（BPF Loader Upgradeable）将程序分为两部分：
     - Program Account（程序账户）：36 字节，包含程序数据账户的地址
     - ProgramData Account（程序数据账户）：实际的可执行代码（Raydium 约 1.4MB）
   
3. **验证程序账户状态**：
   ```bash
   solana account 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8 --url http://0.0.0.0:8899
   # 输出：
   # Balance: 5.01796789 SOL
   # Executable: true
   # Length: 36 (0x24) bytes  ← 只有指针，没有实际代码
   ```

4. **缺失的程序数据账户**：
   - 本地验证器上虽然有程序账户，但缺少对应的程序数据账户
   - 当交易尝试调用程序时，找不到可执行代码，导致 "Program is not deployed" 错误

### 方案

**使用正确的程序克隆参数**：

将：
```bash
--clone 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8
```

改为：
```bash
--clone-upgradeable-program 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8
```

**完整的验证器启动命令**：
```bash
# 1. 停止旧的验证器
pkill -9 -f solana-test-validator

# 2. 清理 ledger
rm -rf .anchor/test-ledger
mkdir -p .anchor/test-ledger

# 3. 使用正确的参数启动验证器
nohup solana-test-validator --reset \
  --ledger .anchor/test-ledger \
  --bind-address 0.0.0.0 \
  --rpc-port 8899 \
  --url https://api.mainnet-beta.solana.com \
  --clone So11111111111111111111111111111111111111112 \
  --clone EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v \
  --clone Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB \
  --clone mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So \
  --clone-upgradeable-program 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8 \
  --clone TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA \
  --clone ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL \
  --clone 58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2 \
  --clone 5Q544fKrFoe6tsEbD7S8EmxGTJYAKtTVhAW5Q5pge4j1 \
  --clone HmiHHzq4Fym9e1D4qzLS6LDDM3tNsCTBPDWHTLZ763jY \
  --clone CZza3Ej4Mc58MnxWA385itCC9jCo3L1D7zc3LKy1bZMR \
  --clone DQyrAcCrDXQ7NeoqGgDCZwBvWDcYmFCjSb9JtteuvPpz \
  --clone HLmqeL62xR1QoZ1HKKbXRrdN1p3phKpxRMb2VVopvBBz \
  --clone srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX \
  --clone 8BnEgHoWFysVcuFFX7QztDmzuH8r5RFvyP3sYwn1XTh6 \
  --clone 96RyJdJVeo5Yr5FjJRn6AaED89myiD9fjp2Fq3zccrfj \
  --clone 48cNXXS5fKsA3ufrYMHxqmV93L2449tu4Ng9mQS2Mxzt \
  --clone 5KKsLVU6TcbVDK4BS6K1DGDxnh4Q9xjYJ8XaDCG5t8ht \
  --clone FaFLrnxNpW4z6ivYvmDaoxvHXvi7G78veWcjW81siiE6 \
  --clone BmrxsPxDjYavNotwdYNMJm1Z3ruRY5AXTA7m85XZpSYj \
  > validator.log 2>&1 &

# 4. 等待验证器启动（程序克隆需要更长时间）
sleep 30

# 5. 验证程序已正确克隆
solana program show 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8 --url http://0.0.0.0:8899
# 应该看到：
# Program Id: 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8
# ProgramData Address: A7ZG7ByDi8DpzT9Ab7CiXhvgYTJQmaDPJkMDoPitaCQV
# Data Length: 1406384 (0x1575b0) bytes  ← 1.4MB 的可执行代码

# 6. 重新部署自己的程序
anchor deploy

# 7. 运行测试
npm run test:swap
```

**测试成功输出**：
```
✅ Swap executed successfully!
   Source decreased by: 0.1 SOL
   Destination increased by: 19.332898 USDC

✓ Test Files  1 passed (1)
✓ Tests      5 passed (5)
```

**关键学习点**：
- `--clone` 用于克隆普通账户（token mints, pool accounts, 数据账户等）
- `--clone-upgradeable-program` 用于克隆可升级程序，会同时克隆程序账户和程序数据账户
- 可升级程序由两部分组成：36 字节的程序账户 + 大型的程序数据账户
- 验证程序是否正确克隆：检查 `Data Length` 应该是完整的程序大小（MB 级别），而不是仅 36 字节

---

## 参数对比：`--clone` vs `--clone-upgradeable-program`

### `--clone <ADDRESS>`
**用途**：克隆单个账户的数据

**适用场景**：
- Token mint 账户（如 USDC、SOL）
- Token 账户
- 池子的状态账户
- PDA 账户
- 任何数据账户

**克隆内容**：
- 账户的余额（lamports）
- 账户的数据（data）
- 账户的所有者（owner）
- 账户的属性（executable, rent_epoch 等）

**示例**：
```bash
--clone So11111111111111111111111111111111111111112  # SOL mint
--clone EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v  # USDC mint
--clone TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA  # Token Program
```

### `--clone-upgradeable-program <PROGRAM_ID>`
**用途**：克隆可升级 BPF 程序的完整内容

**适用场景**：
- 所有使用 BPF Loader Upgradeable 部署的程序
- Raydium、Orca、Serum 等 DEX 程序
- 任何需要 CPI 调用的第三方程序

**克隆内容**：
- 程序账户（36 字节，包含程序数据地址的指针）
- 程序数据账户（实际的可执行字节码，通常几百 KB 到几 MB）
- 程序的升级权限信息

**示例**：
```bash
--clone-upgradeable-program 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8  # Raydium AMM
--clone-upgradeable-program whirLbMiicVdio4qvUfM5KAg6Ct8VwpYzGff3uctyCc  # Orca Whirlpool
```

### 如何判断使用哪个参数？

1. **查看账户信息**：
   ```bash
   solana account <ADDRESS> --url https://api.mainnet-beta.solana.com
   ```

2. **判断规则**：
   - 如果 `Owner: BPFLoaderUpgradeab1e11111111111111111111111` 且 `Length: 36 bytes`
     → 这是程序账户，使用 `--clone-upgradeable-program`
   
   - 如果 `Owner: TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA` 或其他
     → 这是数据账户，使用 `--clone`

3. **程序列表查询**：
   ```bash
   solana program show <PROGRAM_ID> --url https://api.mainnet-beta.solana.com
   ```
   如果能显示 `ProgramData Address`，说明这是可升级程序，需要使用 `--clone-upgradeable-program`

---

## 常见的 Solana 程序克隆清单

### 需要使用 `--clone-upgradeable-program` 的程序：

```bash
# Raydium AMM V4
--clone-upgradeable-program 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8

# Orca Whirlpool
--clone-upgradeable-program whirLbMiicVdio4qvUfM5KAg6Ct8VwpYzGff3uctyCc

# Serum DEX V3
--clone-upgradeable-program 9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin

# Meteora DLMM
--clone-upgradeable-program LBUZKhRxPF3XUpBCjp4YzTKgLccjZhTSDM9YuVaPwxo
```

### 需要使用 `--clone` 的账户：

```bash
# Token Programs (这些是原生程序，不是可升级的)
--clone TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA  # Token Program
--clone ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL  # Associated Token Program

# Token Mints
--clone So11111111111111111111111111111111111111112  # Wrapped SOL
--clone EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v  # USDC
--clone Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB  # USDT

# Pool Accounts
--clone 58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2  # 某个 Raydium Pool ID
--clone 5Q544fKrFoe6tsEbD7S8EmxGTJYAKtTVhAW5Q5pge4j1  # 某个 Raydium Authority
```

---

## 完整的本地测试工作流程

### 1. 首次启动本地测试网络

```bash
# 清理环境
pkill -9 -f solana-test-validator
rm -rf .anchor/test-ledger
anchor clean

# 构建程序
anchor build

# 创建 ledger 目录
mkdir -p .anchor/test-ledger

# 启动验证器（包含所有必要的克隆）
nohup solana-test-validator --reset \
  --ledger .anchor/test-ledger \
  --bind-address 0.0.0.0 \
  --rpc-port 8899 \
  --url https://api.mainnet-beta.solana.com \
  --clone So11111111111111111111111111111111111111112 \
  --clone EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v \
  --clone TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA \
  --clone ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL \
  --clone-upgradeable-program 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8 \
  --clone 58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2 \
  --clone 5Q544fKrFoe6tsEbD7S8EmxGTJYAKtTVhAW5Q5pge4j1 \
  --clone HmiHHzq4Fym9e1D4qzLS6LDDM3tNsCTBPDWHTLZ763jY \
  --clone CZza3Ej4Mc58MnxWA385itCC9jCo3L1D7zc3LKy1bZMR \
  --clone DQyrAcCrDXQ7NeoqGgDCZwBvWDcYmFCjSb9JtteuvPpz \
  --clone HLmqeL62xR1QoZ1HKKbXRrdN1p3phKpxRMb2VVopvBBz \
  --clone srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX \
  --clone 8BnEgHoWFysVcuFFX7QztDmzuH8r5ZFvyP3sYwn1XTh6 \
  --clone 96RyJdJVeo5Yr5FjJRn6AaED89myiD9fjp2Fq3zccrfj \
  --clone 48cNXXS5fKsA3ufrYMHxqmV93L2449tu4Ng9mQS2Mxzt \
  --clone 5KKsLVU6TcbVDK4BS6K1DGDxnh4Q9xjYJ8XaDCG5t8ht \
  --clone FaFLrnxNpW4z6ivYvmDaoxvHXvi7G78veWcjW81siiE6 \
  --clone BmrxsPxDjYavNotwdYNMJm1Z3ruRY5AXTA7m85XZpSYj \
  > validator.log 2>&1 &

# 等待验证器启动
sleep 30

# 验证验证器状态
ps aux | grep solana-test-validator
tail -20 validator.log

# 部署程序
anchor deploy

# 运行测试
npm run test:swap
```

### 2. 代码修改后重新部署

```bash
# 如果只修改了自己的程序代码，不需要重启验证器
anchor build
anchor deploy

# 如果遇到部署错误，执行完整重置
pkill -9 -f solana-test-validator
rm -rf .anchor/test-ledger
anchor clean
# ... 然后重新执行首次启动流程
```

### 3. 调试技巧

```bash
# 查看验证器日志
tail -f validator.log

# 查看程序是否正确部署
solana program show <PROGRAM_ID> --url http://0.0.0.0:8899

# 查看账户信息
solana account <ADDRESS> --url http://0.0.0.0:8899

# 查看钱包余额
solana balance --url http://0.0.0.0:8899

# 获取最近的交易日志
solana logs --url http://0.0.0.0:8899
```

---

## 总结

### 核心要点

1. **部署错误通常源于状态冲突**
   - 解决方案：彻底清理环境（停止进程 + 删除缓存 + 清理构建产物）
   - 关键命令：`pkill -9`, `rm -rf .anchor`, `anchor clean`

2. **程序克隆需要使用正确的参数**
   - 可升级程序：使用 `--clone-upgradeable-program`
   - 数据账户：使用 `--clone`
   - 区别：程序需要克隆程序账户 + 程序数据账户（完整的可执行代码）

3. **验证器启动顺序很重要**
   - 清理 → 构建 → 创建目录 → 启动验证器 → 等待 → 部署 → 测试
   - 克隆可升级程序需要更长的启动时间（20-30秒）

4. **调试流程**
   - 查看 validator.log 确认验证器状态
   - 使用 `solana program show` 验证程序是否正确克隆
   - 检查程序数据长度：应该是 MB 级别，不是 36 字节

### 最佳实践

1. **开发环境设置**
   ```bash
   # 将验证器启动命令保存为脚本
   cat > start-validator.sh << 'EOF'
   #!/bin/bash
   pkill -9 -f solana-test-validator
   rm -rf .anchor/test-ledger
   mkdir -p .anchor/test-ledger
   
   nohup solana-test-validator --reset \
     --ledger .anchor/test-ledger \
     --bind-address 0.0.0.0 \
     --rpc-port 8899 \
     --url https://api.mainnet-beta.solana.com \
     --clone So11111111111111111111111111111111111111112 \
     --clone EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v \
     --clone TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA \
     --clone ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL \
     --clone-upgradeable-program 675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8 \
     --clone 58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2 \
     --clone 5Q544fKrFoe6tsEbD7S8EmxGTJYAKtTVhAW5Q5pge4j1 \
     --clone HmiHHzq4Fym9e1D4qzLS6LDDM3tNsCTBPDWHTLZ763jY \
     --clone CZza3Ej4Mc58MnxWA385itCC9jCo3L1D7zc3LKy1bZMR \
     --clone DQyrAcCrDXQ7NeoqGgDCZwBvWDcYmFCjSb9JtteuvPpz \
     --clone HLmqeL62xR1QoZ1HKKbXRrdN1p3phKpxRMb2VVopvBBz \
     --clone srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX \
     --clone 8BnEgHoWFysVcuFFX7QztDmzuH8r5ZFvyP3sYwn1XTh6 \
     --clone 96RyJdJVeo5Yr5FjJRn6AaED89myiD9fjp2Fq3zccrfj \
     --clone 48cNXXS5fKsA3ufrYMHxqmV93L2449tu4Ng9mQS2Mxzt \
     --clone 5KKsLVU6TcbVDK4BS6K1DGDxnh4Q9xjYJ8XaDCG5t8ht \
     --clone FaFLrnxNpW4z6ivYvmDaoxvHXvi7G78veWcjW81siiE6 \
     --clone BmrxsPxDjYavNotwdYNMJm1Z3ruRY5AXTA7m85XZpSYj \
     > validator.log 2>&1 &
   
   echo "Waiting for validator to start..."
   sleep 30
   echo "Validator started. Check validator.log for details."
   EOF
   
   chmod +x start-validator.sh
   ```

2. **快速重置脚本**
   ```bash
   cat > reset-and-deploy.sh << 'EOF'
   #!/bin/bash
   ./start-validator.sh
   anchor clean
   anchor build
   anchor deploy
   EOF
   
   chmod +x reset-and-deploy.sh
   ```

3. **记住程序克隆规则**
   - 如果要调用某个 DEX 的程序（Raydium、Orca 等）→ `--clone-upgradeable-program`
   - 如果只需要读取 token mint 或池子数据 → `--clone`
   - 原生程序（Token Program、System Program）→ `--clone`（它们已经内置，但克隆也无妨）

通过本次调试，我们成功解决了部署冲突和程序克隆问题，DEX Router 的 swap 功能在本地测试网络上完美运行，成功将 0.1 SOL 兑换为 19.33 USDC！

