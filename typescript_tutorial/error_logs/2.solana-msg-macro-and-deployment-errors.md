# Solana 程序日志宏和部署错误 - 学习复盘文档

## 概述
本文档记录了在开发 Solana DEX Router 程序时遇到的 `msg!` 宏语法错误和程序部署失败的问题。通过这次调试过程，深入理解了 Rust 宏的正确使用方式以及 Solana 本地测试环境的状态管理。

---

## 错误1：msg! 宏参数未被使用

### 背景
在 `common_swap.rs` 文件中添加日志输出，用于调试 DEX swap 功能中的 `fork_amount_out` 变量值。使用 Anchor 框架提供的 `msg!` 宏来记录日志。

### 错误
```
argument never used
argument never used
```

编译时在第 539 行报错，提示传递给 `msg!` 宏的参数从未被使用。

### 原因
`msg!` 宏使用了类似 `println!` 的格式化语法，需要在格式字符串中使用占位符 `{}` 来引用变量。错误的写法：
```rust
msg!("fork amount out is:", fork_amount_out);
```

这种写法中，逗号后的 `fork_amount_out` 参数被传递了但格式字符串中没有对应的占位符，导致参数未被使用。

### 方案
修改为正确的格式化字符串语法，在字符串中添加 `{}` 占位符：
```rust
msg!("fork amount out is: {}", fork_amount_out);
```

**关键点**：Rust 的格式化宏（`println!`, `format!`, `msg!` 等）都需要在格式字符串中明确指定占位符的位置。

---

## 错误2：Solana 程序部署失败 - 可执行账户余额变更错误

### 背景
修复 `msg!` 宏错误后，重新构建程序并尝试部署到本地测试网络（localnet）。使用 `anchor deploy` 命令进行部署。

### 错误
```
Error: Error processing Instruction 2: instruction changed the balance of an executable account
There was a problem deploying: Output { status: ExitStatus(unix_wait_status(256)), stdout: "", stderr: "" }.
```

部署失败，提示指令尝试修改可执行账户的余额。

### 原因
1. **验证器状态陈旧**：本地 Solana 测试验证器（test-validator）中保留了之前部署的程序账户数据。
2. **账户状态冲突**：当程序被修改重新构建后，新程序的大小或结构可能发生变化，但验证器账本（ledger）中仍保留旧的账户状态。
3. **升级限制**：在程序账户已标记为可执行的情况下，Solana 的安全机制限制了某些账户属性的修改。

### 方案
**步骤1：完全清理环境**
```bash
# 停止运行中的验证器
pkill -f solana-test-validator

# 清理 Anchor 构建缓存和账本数据
anchor clean
rm -rf .anchor

# 重新构建程序
anchor build
```

**步骤2：启动全新的验证器**
```bash
# 使用 --reset 参数启动验证器，确保账本完全重置
nohup solana-test-validator --reset \
  --ledger .anchor/test-ledger \
  --bind-address 0.0.0.0 \
  --rpc-port 8899 \
  > validator.log 2>&1 &
```

**步骤3：重新部署**
```bash
# 等待验证器完全启动（约5-10秒）
sleep 10

# 部署程序
anchor deploy
```

**关键操作**：
- `--reset` 参数确保验证器从干净状态启动
- 删除 `.anchor` 目录清除所有缓存的账本数据
- `anchor clean` 清理构建产物，确保完全重新编译

---

## 错误3：程序部署失败 - 可执行账户数据变更错误（变体）

### 背景
在第一次清理后重新部署时，遇到了另一个相关但略有不同的错误信息。

### 错误
```
Error: Error processing Instruction 0: instruction changed executable accounts data
```

虽然错误消息略有不同（"data" vs "balance"），但本质上是同一类问题。

### 原因
1. **验证器未完全重启**：虽然执行了清理命令，但验证器进程可能仍在运行或部分资源未释放。
2. **账本数据残留**：`.anchor/test-ledger` 目录中的数据未完全清除。
3. **启动时序问题**：在验证器完全就绪之前就尝试部署程序。

### 方案
**改进的清理和启动流程**：

```bash
# 1. 强制终止所有验证器进程
pkill -9 -f solana-test-validator

# 2. 彻底清理
cd /root/DEX-Router-Solana-V1
rm -rf .anchor test-ledger
anchor clean

# 3. 重新构建
anchor build

# 4. 启动验证器并记录日志
nohup solana-test-validator --reset \
  --ledger .anchor/test-ledger \
  --bind-address 0.0.0.0 \
  --rpc-port 8899 \
  > validator.log 2>&1 &

# 5. 等待验证器完全启动
sleep 10

# 6. 验证验证器状态
ps aux | grep solana-test-validator

# 7. 部署程序
anchor deploy
```

**最终成功输出**：
```
Deploying cluster: http://0.0.0.0:8899
Upgrade authority: /root/.config/solana/id.json
Deploying program "dex_solana"...
Program path: /root/DEX-Router-Solana-V1/target/deploy/dex_solana.so...
Program Id: Dc5FSiBDTHsDiz191WSMJQ694FesS3ngNkS5T4ubjLs

Deploy success
```

---

## 关键学习点

### 1. Rust 格式化宏的正确使用
- 所有格式化宏（`msg!`, `println!`, `format!` 等）都需要在格式字符串中使用占位符
- 占位符 `{}` 用于默认格式化
- 占位符 `{:?}` 用于 Debug 格式化
- 占位符 `{:#?}` 用于美化的 Debug 格式化

### 2. Solana 本地开发环境的状态管理
- 本地验证器会持久化账户状态到账本（ledger）中
- 程序升级时，如果账户结构变化，需要完全重置验证器
- `--reset` 参数是确保干净状态的关键

### 3. 程序部署的最佳实践
- **开发迭代循环**：
  1. 修改代码
  2. `anchor clean` 清理构建产物
  3. `rm -rf .anchor` 清理账本数据
  4. `anchor build` 重新构建
  5. 重启验证器（带 `--reset`）
  6. `anchor deploy` 部署
  
- **调试技巧**：
  - 使用 `validator.log` 记录验证器输出
  - 使用 `ps aux | grep solana-test-validator` 确认进程状态
  - 使用 `solana program show <PROGRAM_ID>` 检查程序账户状态

### 4. Anchor 框架的工作流程
- `anchor build` 生成两个版本：release（部署用）和 test（测试用）
- `anchor deploy` 只部署 release 版本的 `.so` 文件
- `anchor test` 会自动处理验证器启动、部署和测试运行
- `anchor localnet` 可以启动验证器并应用 `Anchor.toml` 中的配置

### 5. 错误信息的理解
- **"instruction changed the balance"**：尝试修改可执行账户的 lamports
- **"instruction changed executable accounts data"**：尝试修改可执行账户的数据
- **根本原因**：都指向账户状态冲突，需要重置验证器

---

## 常见问题排查清单

当遇到 Solana 部署错误时，按以下顺序检查：

- [ ] 是否有验证器进程正在运行？（`ps aux | grep solana-test-validator`）
- [ ] 是否清理了 `.anchor` 目录？
- [ ] 是否执行了 `anchor clean`？
- [ ] 是否使用 `--reset` 参数启动验证器？
- [ ] 验证器是否完全启动？（至少等待 10 秒）
- [ ] 程序是否成功构建？（检查 `target/deploy/dex_solana.so`）
- [ ] 是否有足够的 SOL 用于部署？（`solana balance`）

---

## 相关命令参考

### 验证器管理
```bash
# 启动验证器
solana-test-validator --reset --ledger .anchor/test-ledger

# 停止验证器
pkill -f solana-test-validator

# 查看验证器日志
tail -f validator.log
```

### 程序管理
```bash
# 查看程序信息
solana program show <PROGRAM_ID>

# 查看程序账户
solana account <PROGRAM_ID>

# 扩展程序账户大小
solana program extend <PROGRAM_ID> <BYTES>

# 关闭程序（回收 SOL）
solana program close <PROGRAM_ID>
```

### Anchor 命令
```bash
# 完整的构建-部署流程
anchor clean
anchor build
anchor deploy

# 自动化测试（包含验证器启动和部署）
anchor test

# 仅启动验证器
anchor localnet
```

---

## 错误4：测试失败 - Token 账户初始化错误

### 背景
程序成功部署后，运行集成测试来验证 DEX swap 功能。测试尝试使用 mainnet 的 token 地址（SOL、USDC）进行交易。

### 错误
```
Error: Transaction simulation failed: Error processing Instruction 3: incorrect program id for instruction.
Program log: Error: IncorrectProgramId
Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA failed: incorrect program id for instruction
```

测试在初始化 token 账户时失败。

### 原因
1. **验证器缺少 mainnet 账户克隆**：手动启动的验证器（`solana-test-validator --reset`）没有克隆 mainnet 的 token mint 账户。
2. **Token mint 不存在**：测试尝试为 `EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v`（USDC）和 `So11111111111111111111111111111111111111112`（SOL）创建 token 账户，但这些 mint 账户在本地验证器上不存在。
3. **配置不一致**：`Anchor.toml` 中配置了大量 mainnet 账户克隆，但手动启动验证器时没有应用这些配置。

### 方案
使用 `anchor localnet` 代替手动启动验证器：

```bash
# 错误的方式（不会克隆 mainnet 账户）
solana-test-validator --reset --ledger .anchor/test-ledger

# 正确的方式（自动应用 Anchor.toml 配置）
anchor localnet
```

**`anchor localnet` 的优势**：
1. 自动读取 `Anchor.toml` 中的 `[[test.validator.clone]]` 配置
2. 自动克隆指定的 mainnet 账户和程序
3. 自动部署项目程序到验证器
4. 确保测试环境与配置文件一致

**验证账户已克隆**：
```bash
# 检查 USDC mint 是否存在
solana account EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v

# 检查验证器启动参数
ps aux | grep solana-test-validator
# 应该看到 --clone EPjFWdd5... --clone So11111... 等参数
```

---

## 错误5：程序 ID 不匹配错误

### 背景
修复 token 账户问题后，测试能够正确初始化账户，但在执行 swap 指令时仍然失败。

### 错误
```
AnchorError occurred. Error Code: DeclaredProgramIdMismatch. Error Number: 4100. 
Error Message: The declared program id does not match the actual program id.
Program 8s7FGtLR1P1Wy6BxsAxWczKeTu3dtfMv12QFwsoaCxdx consumed 7471 of 200000 compute units
Program 8s7FGtLR1P1Wy6BxsAxWczKeTu3dtfMv12QFwsoaCxdx failed: custom program error: 0x1004
```

程序运行时检测到程序 ID 不匹配。

### 原因
1. **源码中的 ID 未更新**：虽然生成了新的程序 keypair 并更新了 `Anchor.toml`，但 `programs/dex-solana/src/lib.rs` 中的 `declare_id!` 宏仍然使用旧的程序 ID。
2. **双重声明机制**：Solana 程序需要在两个地方声明 ID：
   - `Anchor.toml` - 用于部署时确定程序地址
   - `lib.rs` 中的 `declare_id!` - 编译到程序二进制中，运行时验证
3. **不一致导致失败**：运行时，程序会检查 `declare_id!` 声明的 ID 是否与实际部署的地址匹配，不匹配则拒绝执行。

### 方案
**步骤1：更新源码中的程序 ID**

```rust
// programs/dex-solana/src/lib.rs
// 旧的 ID
declare_id!("Dc5FSiBDTHsDiz191WSMJQ694FesS3ngNkS5T4ubjLs");

// 改为新的 ID（与 Anchor.toml 和 keypair 一致）
declare_id!("8s7FGtLR1P1Wy6BxsAxWczKeTu3dtfMv12QFwsoaCxdx");
```

**步骤2：重新构建程序**
```bash
anchor build
```

这会将新的程序 ID 编译到二进制文件中。

**步骤3：重新部署**
```bash
# 清理旧的验证器状态
pkill -f solana-test-validator
rm -rf .anchor/test-ledger

# 使用 anchor localnet 重新启动（会自动部署新构建的程序）
anchor localnet
```

**验证程序 ID 一致性**：
```bash
# 1. 检查 Anchor.toml
grep "dex_solana" Anchor.toml
# dex_solana = "8s7FGtLR1P1Wy6BxsAxWczKeTu3dtfMv12QFwsoaCxdx"

# 2. 检查 keypair
solana-keygen pubkey target/deploy/dex_solana-keypair.json
# 8s7FGtLR1P1Wy6BxsAxWczKeTu3dtfMv12QFwsoaCxdx

# 3. 检查源码
grep "declare_id" programs/dex-solana/src/lib.rs
# declare_id!("8s7FGtLR1P1Wy6BxsAxWczKeTu3dtfMv12QFwsoaCxdx");
```

**关键学习点**：
- 更改程序 keypair 后，必须同时更新 `lib.rs` 中的 `declare_id!`
- 三个位置必须保持一致：Anchor.toml、keypair 文件、lib.rs
- 不一致会导致运行时错误，而不是编译时错误

---

## 测试结果

修复所有问题后，测试成功通过：

```
✅ Test Results:
✓ Test Files: 1 passed
✓ Tests: 5 passed (5)
✓ Swap executed successfully
  - Source decreased by: 0.1 SOL
  - Destination increased by: 18.388321 USDC
  - Transaction confirmed
```

---

## 完整工作流程总结

### 正确的开发流程

1. **修改代码后的部署流程**：
```bash
# 1. 停止验证器
pkill -f solana-test-validator

# 2. 清理环境
rm -rf .anchor/test-ledger
anchor clean

# 3. 构建程序
anchor build

# 4. 启动验证器并自动部署
anchor localnet

# 5. 运行测试
npm run test:swap
```

2. **更改程序 ID 的完整流程**：
```bash
# 1. 生成新 keypair
solana-keygen new -o target/deploy/dex_solana-keypair.json --force --no-bip39-passphrase

# 2. 获取新的程序 ID
NEW_ID=$(solana-keygen pubkey target/deploy/dex_solana-keypair.json)

# 3. 更新 Anchor.toml
sed -i "s/dex_solana = .*/dex_solana = \"$NEW_ID\"/" Anchor.toml

# 4. 更新 lib.rs
# 手动编辑 programs/dex-solana/src/lib.rs 中的 declare_id!

# 5. 重新构建和部署
anchor clean
anchor build
rm -rf .anchor/test-ledger
anchor localnet
```

3. **调试清单**：
- [ ] 程序 ID 在三处保持一致（Anchor.toml、keypair、lib.rs）
- [ ] 验证器通过 `anchor localnet` 启动（自动克隆 mainnet 账户）
- [ ] 账本数据已清理（`rm -rf .anchor/test-ledger`）
- [ ] 程序已重新构建（`anchor build`）
- [ ] 所需的 mainnet 账户已在 `Anchor.toml` 中配置

---

## 总结

这次完整的调试过程涵盖了从语法错误到环境配置的多个层面：

1. **语法层面**：Rust 格式化宏的正确使用
2. **部署层面**：验证器状态管理和程序升级冲突
3. **配置层面**：mainnet 账户克隆和测试环境配置
4. **架构层面**：程序 ID 的多重声明机制和一致性要求

通过系统的排查和修复，不仅解决了所有问题，还深入理解了：
- Anchor 框架的工作机制
- Solana 程序的部署和升级流程
- 本地测试环境的正确配置方法
- 程序 ID 管理的最佳实践

最终，DEX Router 程序成功部署并通过所有测试，实现了 SOL/USDC 的交易功能（0.1 SOL → 18.39 USDC），证明了程序的正确性和完整性。

