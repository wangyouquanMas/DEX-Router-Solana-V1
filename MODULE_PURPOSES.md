# DEX-Router-Solana-V1 Module Architecture Guide

## ğŸ“ Project Structure Overview

This document explains the purpose and responsibility of each module in the DEX Router Solana V1 project.

---

## ğŸ¨ Visual Architecture Diagrams

### 1. High-Level System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER / CLIENT APPLICATION                        â”‚
â”‚                    (Web3 Wallet, dApp, Trading Bot)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ RPC Call
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           SOLANA BLOCKCHAIN                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               DEX ROUTER PROGRAM (lib.rs)                         â”‚  â”‚
â”‚  â”‚              Program ID: C5x9...pmR                               â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚  INSTRUCTION LAYER (/instructions/)                     â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  swap    â”‚  â”‚commissionâ”‚  â”‚  proxy   â”‚  â”‚ swap_v3 â”‚â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ handler  â”‚  â”‚  handler â”‚  â”‚ handler  â”‚  â”‚ handler â”‚â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â”‚    â”‚  â”‚
â”‚  â”‚  â”‚       â”‚             â”‚             â”‚             â”‚      â”‚    â”‚  â”‚
â”‚  â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                          â”‚                             â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚ common_swap.rs  â”‚                    â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚  â€¢ SwapArgs     â”‚                    â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚  â€¢ Route        â”‚                    â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚  â€¢ Dex enum     â”‚                    â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚  â€¢ HopAccounts  â”‚                    â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                             â”‚                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  ADAPTER LAYER (/adapters/)                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Raydium  â”‚  â”‚Whirlpool â”‚  â”‚ Meteora  â”‚  â”‚  40+    â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Adapter  â”‚  â”‚ Adapter  â”‚  â”‚ Adapter  â”‚  â”‚  More   â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       â”‚             â”‚             â”‚             â”‚      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       â”‚   CPI (Cross-Program Invocation)        â”‚      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       â–¼             â–¼             â–¼             â–¼      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚          â”‚             â”‚             â”‚             â”‚         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚   Raydium    â”‚ â”‚  Orca    â”‚ â”‚ Meteora  â”‚ â”‚ Phoenix  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚   Program    â”‚ â”‚ Program  â”‚ â”‚ Program  â”‚ â”‚ Program  â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  UTILITY LAYER (/utils/)                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ token.rs (SPL Token operations)                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ fee.rs (Fee calculations)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ swap.rs (Swap math & validation)                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ logging.rs (Event emission)                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  STATE LAYER (/state/)                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ config.rs (GlobalConfig account)                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ order.rs (Limit order accounts)                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ event.rs (Event definitions)                       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. Swap Execution Flow (Detailed Sequence)

```
USER: "Swap 1000 USDC â†’ SOL using 60% Raydium + 40% Whirlpool"
â”‚
â”‚ 1. Build SwapArgs
â”‚    â”œâ”€ amount_in: 1,000,000 (1000 USDC with 6 decimals)
â”‚    â”œâ”€ min_return: 970,000 (0.97 SOL minimum)
â”‚    â””â”€ routes: [
â”‚         Route { dexes: [Raydium, Whirlpool], weights: [60, 40] }
â”‚       ]
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: lib.rs::swap()                                       â”‚
â”‚  â€¢ Receives transaction                                       â”‚
â”‚  â€¢ Validates signature & accounts                             â”‚
â”‚  â€¢ Routes to instruction handler                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: instructions/swap.rs::swap_handler()                 â”‚
â”‚  â€¢ Validates SwapArgs structure                               â”‚
â”‚  â€¢ Checks user token balances                                 â”‚
â”‚  â€¢ Verifies accounts ownership                                â”‚
â”‚  â€¢ Calls common swap logic                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: instructions/common_swap.rs::distribute_swap()       â”‚
â”‚  â€¢ Parses Route: [Raydium: 60%, Whirlpool: 40%]              â”‚
â”‚  â€¢ Splits input: 600 USDC + 400 USDC                         â”‚
â”‚  â€¢ Initializes HopAccounts tracking                           â”‚
â”‚  â€¢ Loops through each DEX in route                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                             â”‚
              â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4A: Raydium Path       â”‚  â”‚  STEP 4B: Whirlpool Path    â”‚
â”‚  (60% = 600 USDC)            â”‚  â”‚  (40% = 400 USDC)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                 â”‚
               â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  adapters/raydium.rs           â”‚  â”‚  adapters/whirlpool.rs    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. before_invoke()       â”‚  â”‚  â”‚  â”‚ 1. before_invoke()  â”‚  â”‚
â”‚  â”‚    â€¢ Get pre-swap balanceâ”‚  â”‚  â”‚  â”‚    â€¢ Check balance  â”‚  â”‚
â”‚  â”‚                          â”‚  â”‚  â”‚  â”‚                     â”‚  â”‚
â”‚  â”‚ 2. Build swap IX         â”‚  â”‚  â”‚  â”‚ 2. Build swap IX    â”‚  â”‚
â”‚  â”‚    â€¢ Prepare accounts    â”‚  â”‚  â”‚  â”‚    â€¢ Prepare pools  â”‚  â”‚
â”‚  â”‚    â€¢ Set amount: 600 USDCâ”‚  â”‚  â”‚  â”‚    â€¢ Set amt: 400   â”‚  â”‚
â”‚  â”‚                          â”‚  â”‚  â”‚  â”‚                     â”‚  â”‚
â”‚  â”‚ 3. Execute CPI           â”‚  â”‚  â”‚  â”‚ 3. Execute CPI      â”‚  â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚    â”‚ Raydium Program â”‚   â”‚  â”‚  â”‚  â”‚    â”‚Orca Program  â”‚ â”‚  â”‚
â”‚  â”‚    â”‚ Executes swap   â”‚   â”‚  â”‚  â”‚  â”‚    â”‚Executes swap â”‚ â”‚  â”‚
â”‚  â”‚    â”‚ Returns ~0.588  â”‚   â”‚  â”‚  â”‚  â”‚    â”‚Returns ~0.392â”‚ â”‚  â”‚
â”‚  â”‚    â”‚ SOL             â”‚   â”‚  â”‚  â”‚  â”‚    â”‚SOL           â”‚ â”‚  â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                          â”‚  â”‚  â”‚  â”‚                     â”‚  â”‚
â”‚  â”‚ 4. after_invoke()        â”‚  â”‚  â”‚  â”‚ 4. after_invoke()   â”‚  â”‚
â”‚  â”‚    â€¢ Verify output       â”‚  â”‚  â”‚  â”‚    â€¢ Verify output  â”‚  â”‚
â”‚  â”‚    â€¢ Calculate received  â”‚  â”‚  â”‚  â”‚    â€¢ Update balance â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                     â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: Aggregate Results                                    â”‚
â”‚  â€¢ Raydium output: 0.588 SOL                                  â”‚
â”‚  â€¢ Whirlpool output: 0.392 SOL                                â”‚
â”‚  â€¢ Total received: 0.98 SOL                                   â”‚
â”‚  â€¢ Check: 0.98 >= min_return (0.97) âœ“                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: utils/ Operations                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ token.rs: Transfer 0.98 SOL to user's account          â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ fee.rs: Calculate & distribute platform fees           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ logging.rs: Emit SwapEvent                              â”‚  â”‚
â”‚  â”‚   {                                                     â”‚  â”‚
â”‚  â”‚     user: <user_pubkey>,                                â”‚  â”‚
â”‚  â”‚     input_mint: USDC,                                   â”‚  â”‚
â”‚  â”‚     output_mint: SOL,                                   â”‚  â”‚
â”‚  â”‚     amount_in: 1000,                                    â”‚  â”‚
â”‚  â”‚     amount_out: 0.98,                                   â”‚  â”‚
â”‚  â”‚     dexes_used: [Raydium, Whirlpool]                    â”‚  â”‚
â”‚  â”‚   }                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 7: Transaction Complete                                 â”‚
â”‚  âœ… User receives 0.98 SOL                                    â”‚
â”‚  âœ… Event logged on-chain                                     â”‚
â”‚  âœ… UI can display swap details                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Adapter Pattern Implementation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  THE ADAPTER PATTERN PROBLEM                                        â”‚
â”‚                                                                     â”‚
â”‚  Challenge: 40+ DEXs, each with different interfaces                â”‚
â”‚  â€¢ Raydium: Uses AMM pools, specific account structure              â”‚
â”‚  â€¢ Orca: Concentrated liquidity, different math                     â”‚
â”‚  â€¢ Phoenix: Orderbook-based, completely different model             â”‚
â”‚  â€¢ Meteora: Dynamic bins, unique parameters                         â”‚
â”‚                                                                     â”‚
â”‚  Without adapters: Router needs 40+ different code paths! ğŸ˜±        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  THE SOLUTION: UNIFIED ADAPTER INTERFACE                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  adapters/common.rs                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  pub trait DexProcessor {                               â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚      fn before_invoke(                                  â”‚  â”‚
â”‚  â”‚          &self,                                          â”‚  â”‚
â”‚  â”‚          account_infos: &[AccountInfo]                   â”‚  â”‚
â”‚  â”‚      ) -> Result<u64>;                                   â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚      fn after_invoke(                                   â”‚  â”‚
â”‚  â”‚          &self,                                          â”‚  â”‚
â”‚  â”‚          account_infos: &[AccountInfo],                  â”‚  â”‚
â”‚  â”‚          hop: usize,                                     â”‚  â”‚
â”‚  â”‚          owner_seeds: Option<&[&[&[u8]]]>               â”‚  â”‚
â”‚  â”‚      ) -> Result<u64>;                                   â”‚  â”‚
â”‚  â”‚  }                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ ALL adapters implement this trait
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚                  â”‚
        â–¼                     â–¼                     â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ raydium.rs    â”‚    â”‚ whirlpool.rs  â”‚    â”‚ meteora.rs    â”‚   â”‚  40+     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  more... â”‚
â”‚impl           â”‚    â”‚impl           â”‚    â”‚impl           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚DexProcessor { â”‚    â”‚DexProcessor { â”‚    â”‚DexProcessor { â”‚
â”‚               â”‚    â”‚               â”‚    â”‚               â”‚
â”‚ before_invoke â”‚    â”‚ before_invoke â”‚    â”‚ before_invoke â”‚
â”‚  â†’ Get AMM    â”‚    â”‚  â†’ Get CLMM   â”‚    â”‚  â†’ Get DLMM   â”‚
â”‚    pool data  â”‚    â”‚    tick data  â”‚    â”‚    bin data   â”‚
â”‚               â”‚    â”‚               â”‚    â”‚               â”‚
â”‚ after_invoke  â”‚    â”‚ after_invoke  â”‚    â”‚ after_invoke  â”‚
â”‚  â†’ Verify AMM â”‚    â”‚  â†’ Verify     â”‚    â”‚  â†’ Verify     â”‚
â”‚    swap resultâ”‚    â”‚    position   â”‚    â”‚    bins       â”‚
â”‚}              â”‚    â”‚}              â”‚    â”‚}              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ROUTER USAGE (Simplified)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  match dex_type {                                             â”‚  â”‚
â”‚  â”‚      Dex::RaydiumSwap => {                                    â”‚  â”‚
â”‚  â”‚          let adapter = RaydiumAdapter::new();                 â”‚  â”‚
â”‚  â”‚          adapter.before_invoke(accounts)?;  // Unified call   â”‚  â”‚
â”‚  â”‚          // Execute swap...                                   â”‚  â”‚
â”‚  â”‚          adapter.after_invoke(accounts)?;   // Unified call   â”‚  â”‚
â”‚  â”‚      },                                                        â”‚  â”‚
â”‚  â”‚      Dex::Whirlpool => {                                      â”‚  â”‚
â”‚  â”‚          let adapter = WhirlpoolAdapter::new();               â”‚  â”‚
â”‚  â”‚          adapter.before_invoke(accounts)?;  // Same interface â”‚  â”‚
â”‚  â”‚          // Execute swap...                                   â”‚  â”‚
â”‚  â”‚          adapter.after_invoke(accounts)?;   // Same interface â”‚  â”‚
â”‚  â”‚      },                                                        â”‚  â”‚
â”‚  â”‚      // ... 40+ more DEXs, all using the same interface!     â”‚  â”‚
â”‚  â”‚  }                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Benefits:
âœ… Router code stays clean - doesn't need DEX-specific logic
âœ… Easy to add new DEXs - just implement DexProcessor trait
âœ… Each adapter encapsulates DEX complexity
âœ… Testable in isolation
```

---

### 4. Data Structure Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SwapArgs (The Complete Swap Specification)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  pub struct SwapArgs {                                       â”‚  â”‚
â”‚  â”‚      pub amount_in: u64,        // Total input: 1000 USDC   â”‚  â”‚
â”‚  â”‚      pub expect_amount_out: u64, // Expected: ~0.98 SOL     â”‚  â”‚
â”‚  â”‚      pub min_return: u64,       // Minimum: 0.97 SOL        â”‚  â”‚
â”‚  â”‚      pub amounts: Vec<u64>,     // Level 1 split â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚      pub routes: Vec<Vec<Route>>, // Level 2 split â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  }                                                        â”‚â”‚  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”¼â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”¼â”€â”€â”€â”€â”€â”˜
                                                               â”‚â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  Level 1 Split: Route-Level Distribution                      â”‚
â”‚  amounts: [600, 400]  â† Split input into parallel routes     â”‚
â”‚                                                               â”‚
â”‚  Route 1: 600 USDC â”€â”€â”€â”€â”€â”       Route 2: 400 USDC â”€â”€â”€â”€â”€â”    â”‚
â”‚                         â”‚                               â”‚    â”‚
â”‚                         â–¼                               â–¼    â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                  â”‚  Vec<Route> â”‚               â”‚  Vec<Route> â”‚â”‚
â”‚                  â”‚  (Multi-hop)â”‚               â”‚  (Multi-hop)â”‚â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                         â”‚                             â”‚       â”‚
â”‚                         â–¼                             â–¼       â”‚
â”‚                   [ Route 1 ]                   [ Route 1,    â”‚
â”‚                                                   Route 2 ]   â”‚
â”‚                                                  (2-hop path) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                          â”‚
                            â–¼                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  Level 2 Split: DEX-Weight Distribution            â”‚ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  pub struct Route {                          â”‚  â”‚ â”‚
â”‚  â”‚      pub dexes: Vec<Dex>,   // DEX list â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”¤
â”‚  â”‚      pub weights: Vec<u8>,  // Weight % â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”¤
â”‚  â”‚  }                                           â”‚  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                              â”‚                        â”‚
                              â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Route Example 1 (Simple)            â”‚  â”‚  Route Example 2      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  (Split)              â”‚
â”‚  â”‚  dexes: [Raydium]              â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  weights: [100]                â”‚  â”‚  â”‚  â”‚ dexes:          â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚  â”‚  â”‚  [Whirlpool,    â”‚  â”‚
â”‚  â”‚  Meaning:                      â”‚  â”‚  â”‚  â”‚   Meteora]      â”‚  â”‚
â”‚  â”‚  100% via Raydium              â”‚  â”‚  â”‚  â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚ weights: [60,40]â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                 â”‚  â”‚
                                          â”‚  â”‚ Meaning:        â”‚  â”‚
                                          â”‚  â”‚ 60% Whirlpool   â”‚  â”‚
                                          â”‚  â”‚ 40% Meteora     â”‚  â”‚
                                          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dex Enum (77 Supported DEXs)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  #[derive(AnchorSerialize, AnchorDeserialize, Clone)]   â”‚  â”‚
â”‚  â”‚  pub enum Dex {                                          â”‚  â”‚
â”‚  â”‚      SplTokenSwap,          // #0                        â”‚  â”‚
â”‚  â”‚      Whirlpool,             // #1                        â”‚  â”‚
â”‚  â”‚      RaydiumSwap,           // #2                        â”‚  â”‚
â”‚  â”‚      Meteora,               // #3                        â”‚  â”‚
â”‚  â”‚      MeteoraDlmm,           // #4                        â”‚  â”‚
â”‚  â”‚      OpenBookV2,            // #5                        â”‚  â”‚
â”‚  â”‚      Phoenix,               // #6                        â”‚  â”‚
â”‚  â”‚      Pumpfun,               // #7                        â”‚  â”‚
â”‚  â”‚      // ... 69 more DEXs                                 â”‚  â”‚
â”‚  â”‚  }                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HopAccounts (Multi-Hop State Tracking)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  pub struct HopAccounts {                                â”‚  â”‚
â”‚  â”‚      pub last_to_account: Pubkey,   // Previous hop out â”‚  â”‚
â”‚  â”‚      pub from_account: Pubkey,      // Current hop in   â”‚  â”‚
â”‚  â”‚      pub to_account: Pubkey,        // Current hop out  â”‚  â”‚
â”‚  â”‚  }                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â”‚  Example: USDC â†’ USDT â†’ SOL (2-hop)                           â”‚
â”‚                                                                â”‚
â”‚  Hop 1 State:                                                  â”‚
â”‚    last_to_account: ZERO (first hop)                          â”‚
â”‚    from_account: user_usdc_account                            â”‚
â”‚    to_account: temp_usdt_account                              â”‚
â”‚                                                                â”‚
â”‚  Hop 2 State:                                                  â”‚
â”‚    last_to_account: temp_usdt_account  â† Must match Hop 1 outâ”‚
â”‚    from_account: temp_usdt_account                            â”‚
â”‚    to_account: user_sol_account                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5. Module Dependency Graph (Detailed)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚        lib.rs               â”‚
                    â”‚   (Program Entry Point)     â”‚
                    â”‚                             â”‚
                    â”‚  â€¢ Declares program ID      â”‚
                    â”‚  â€¢ Exposes instructions     â”‚
                    â”‚  â€¢ Links all modules        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚              â”‚              â”‚
                â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  instructions/  â”‚  â”‚   state/    â”‚  â”‚global_config/â”‚
    â”‚                 â”‚  â”‚             â”‚  â”‚              â”‚
    â”‚  Entry points   â”‚  â”‚ Data schemasâ”‚  â”‚Admin funcs   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â–¼         â–¼          â–¼          â–¼          â–¼          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
    â”‚common_swap  â”‚ â”‚ swap   â”‚ â”‚commissionâ”‚ â”‚ proxy â”‚ â”‚swap_v3 â”‚ â”‚ ... â”‚
    â”‚    .rs      â”‚ â”‚  .rs   â”‚ â”‚  _swap   â”‚ â”‚ _swap â”‚ â”‚  .rs   â”‚ â”‚     â”‚
    â”‚             â”‚ â”‚        â”‚ â”‚   .rs    â”‚ â”‚  .rs  â”‚ â”‚        â”‚ â”‚     â”‚
    â”‚  Core Data  â”‚ â”‚ Basic  â”‚ â”‚ With fee â”‚ â”‚Delegatâ”‚ â”‚ Latest â”‚ â”‚     â”‚
    â”‚ Structures: â”‚ â”‚ logic  â”‚ â”‚  logic   â”‚ â”‚  ed   â”‚ â”‚version â”‚ â”‚     â”‚
    â”‚             â”‚ â”‚        â”‚ â”‚          â”‚ â”‚       â”‚ â”‚        â”‚ â”‚     â”‚
    â”‚â€¢ SwapArgs   â”‚ â”‚        â”‚ â”‚          â”‚ â”‚       â”‚ â”‚        â”‚ â”‚     â”‚
    â”‚â€¢ Route      â”‚ â”‚        â”‚ â”‚          â”‚ â”‚       â”‚ â”‚        â”‚ â”‚     â”‚
    â”‚â€¢ Dex enum   â”‚ â”‚        â”‚ â”‚          â”‚ â”‚       â”‚ â”‚        â”‚ â”‚     â”‚
    â”‚â€¢ HopAccountsâ”‚ â”‚        â”‚ â”‚          â”‚ â”‚       â”‚ â”‚        â”‚ â”‚     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
           â”‚            â”‚           â”‚            â”‚         â”‚
           â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                        â”‚
           â”‚                        â”‚ Uses SwapArgs & Route
           â”‚                        â”‚
           â–¼                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              adapters/ (40+ DEX Integrations)            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
    â”‚  â”‚ common.rs  â”‚  â† Defines DexProcessor trait            â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
    â”‚        â”‚                                                 â”‚
    â”‚        â”‚ Implemented by:                                 â”‚
    â”‚        â”‚                                                 â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
    â”‚  â”‚                                                 â”‚     â”‚
    â”‚  â–¼                    â–¼                    â–¼       â–¼     â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚ â”‚ raydium  â”‚  â”‚ whirlpool  â”‚  â”‚ meteora â”‚ â”‚  40+    â”‚  â”‚
    â”‚ â”‚  .rs     â”‚  â”‚    .rs     â”‚  â”‚  .rs    â”‚ â”‚ more... â”‚  â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚      â”‚              â”‚               â”‚           â”‚       â”‚
    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
    â”‚                     â”‚                                   â”‚
    â”‚                     â”‚ Uses utils for:                   â”‚
    â”‚                     â”‚                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              utils/ (Shared Utilities)                   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  token.rs                                          â”‚  â”‚
    â”‚  â”‚  â€¢ transfer_from()                                 â”‚  â”‚
    â”‚  â”‚  â€¢ transfer_to()                                   â”‚  â”‚
    â”‚  â”‚  â€¢ create_token_account()                          â”‚  â”‚
    â”‚  â”‚  â€¢ get_balance()                                   â”‚  â”‚
    â”‚  â”‚  â€¢ wrap_sol() / unwrap_sol()                       â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  fee.rs                                            â”‚  â”‚
    â”‚  â”‚  â€¢ calculate_commission()                          â”‚  â”‚
    â”‚  â”‚  â€¢ calculate_platform_fee()                        â”‚  â”‚
    â”‚  â”‚  â€¢ distribute_fees()                               â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  swap.rs                                           â”‚  â”‚
    â”‚  â”‚  â€¢ validate_slippage()                             â”‚  â”‚
    â”‚  â”‚  â€¢ calculate_min_out()                             â”‚  â”‚
    â”‚  â”‚  â€¢ verify_swap_result()                            â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  logging.rs                                        â”‚  â”‚
    â”‚  â”‚  â€¢ emit_swap_event()                               â”‚  â”‚
    â”‚  â”‚  â€¢ log_error()                                     â”‚  â”‚
    â”‚  â”‚  â€¢ track_metrics()                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ Accesses
                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              state/ (On-Chain Accounts)                  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  config.rs â†’ GlobalConfig account                  â”‚  â”‚
    â”‚  â”‚  â€¢ admin: Pubkey                                   â”‚  â”‚
    â”‚  â”‚  â€¢ resolvers: [Pubkey; 5]                          â”‚  â”‚
    â”‚  â”‚  â€¢ trade_fee: u64                                  â”‚  â”‚
    â”‚  â”‚  â€¢ paused: bool                                    â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  order.rs â†’ Order account (Limit orders)           â”‚  â”‚
    â”‚  â”‚  â€¢ user: Pubkey                                    â”‚  â”‚
    â”‚  â”‚  â€¢ making_amount: u64                              â”‚  â”‚
    â”‚  â”‚  â€¢ expect_taking_amount: u64                       â”‚  â”‚
    â”‚  â”‚  â€¢ status: OrderStatus                             â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  event.rs â†’ Event definitions                      â”‚  â”‚
    â”‚  â”‚  â€¢ SwapEvent                                       â”‚  â”‚
    â”‚  â”‚  â€¢ OrderFilledEvent                                â”‚  â”‚
    â”‚  â”‚  â€¢ FeeCollectedEvent                               â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

External Dependencies (via CPI):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Raydium    â”‚  â”‚     Orca     â”‚  â”‚   Meteora    â”‚  â”‚   40+    â”‚
â”‚   Program    â”‚  â”‚   Program    â”‚  â”‚   Program    â”‚  â”‚   DEX    â”‚
â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚ Programs â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6. Two-Level Splitting Mechanism (Visual)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INPUT: 1000 USDC to swap to SOL                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ SwapArgs.amounts = [600, 400]
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                                   â”‚
            â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LEVEL 1: ROUTE SPLIT  â”‚        â”‚   LEVEL 1: ROUTE SPLIT  â”‚
â”‚                         â”‚        â”‚                         â”‚
â”‚   Route 1: 600 USDC     â”‚        â”‚   Route 2: 400 USDC     â”‚
â”‚   (60% of total)        â”‚        â”‚   (40% of total)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                  â”‚
            â”‚ Single hop                       â”‚ Two hops
            â”‚                                  â”‚
            â–¼                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  LEVEL 2: DEX SPLIT     â”‚                   â”‚
â”‚  (Hop 1 of Route 1)     â”‚                   â”‚
â”‚                         â”‚                   â”‚
â”‚  Route {                â”‚                   â”‚
â”‚    dexes: [Raydium],    â”‚                   â”‚
â”‚    weights: [100]       â”‚                   â”‚
â”‚  }                      â”‚                   â”‚
â”‚                         â”‚                   â”‚
â”‚  100% â†’ Raydium         â”‚                   â”‚
â”‚  600 USDC â†’ Raydium     â”‚                   â”‚
â”‚         â†“               â”‚                   â”‚
â”‚  Output: ~0.588 SOL     â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                                              â”‚
                                              â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  LEVEL 2: DEX SPLIT          â”‚
                              â”‚  (Hop 1 of Route 2)          â”‚
                              â”‚                              â”‚
                              â”‚  Route {                     â”‚
                              â”‚    dexes: [Whirlpool,        â”‚
                              â”‚            Meteora],         â”‚
                              â”‚    weights: [60, 40]         â”‚
                              â”‚  }                           â”‚
                              â”‚                              â”‚
                              â”‚  Split 400 USDC:             â”‚
                              â”‚  â”œâ”€ 60% â†’ Whirlpool (240)    â”‚
                              â”‚  â””â”€ 40% â†’ Meteora (160)      â”‚
                              â”‚                              â”‚
                              â”‚  Execute both swaps:         â”‚
                              â”‚  USDC â†’ USDT                 â”‚
                              â”‚  â”œâ”€ Whirlpool: 240 â†’ ~237.6  â”‚
                              â”‚  â””â”€ Meteora: 160 â†’ ~158.4    â”‚
                              â”‚  Total: ~396 USDT            â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚ Hop 2
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  LEVEL 2: DEX SPLIT          â”‚
                              â”‚  (Hop 2 of Route 2)          â”‚
                              â”‚                              â”‚
                              â”‚  Route {                     â”‚
                              â”‚    dexes: [Raydium],         â”‚
                              â”‚    weights: [100]            â”‚
                              â”‚  }                           â”‚
                              â”‚                              â”‚
                              â”‚  100% â†’ Raydium              â”‚
                              â”‚  396 USDT â†’ Raydium          â”‚
                              â”‚         â†“                    â”‚
                              â”‚  Output: ~0.392 SOL          â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FINAL AGGREGATION                                                  â”‚
â”‚                                                                     â”‚
â”‚  Route 1 Output:  0.588 SOL                                        â”‚
â”‚  Route 2 Output:  0.392 SOL                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚  Total Output:    0.980 SOL âœ…                                     â”‚
â”‚                                                                     â”‚
â”‚  Min acceptable:  0.970 SOL                                        â”‚
â”‚  Status: PASS (within slippage tolerance)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY INSIGHTS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 1 (Route Split): WHY?                                       â”‚
â”‚  â€¢ Risk diversification: Don't put all eggs in one basket          â”‚
â”‚  â€¢ Liquidity aggregation: Access multiple liquidity sources        â”‚
â”‚  â€¢ Path optimization: Some paths better for different amounts      â”‚
â”‚  â€¢ Example: Direct path + indirect path for better price           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 2 (DEX Weight Split): WHY?                                  â”‚
â”‚  â€¢ Price optimization: Get best price across multiple DEXs         â”‚
â”‚  â€¢ Liquidity depth: Large swaps need multiple pools                â”‚
â”‚  â€¢ Slippage reduction: Split across pools = less price impact      â”‚
â”‚  â€¢ Example: 60% best DEX + 40% second best = better than 100% one  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ Root Level Configuration Files

### `Anchor.toml`
**Purpose:** Anchor framework configuration file
- Defines program deployment settings
- Specifies cluster endpoints (localnet, devnet, mainnet-beta)
- Configures test script paths
- Sets wallet paths for deployment

### `Cargo.toml` (Workspace Level)
**Purpose:** Rust workspace configuration
- Defines workspace members (links to `programs/dex-solana`)
- Manages shared dependencies across the workspace
- Sets up common build configurations

---

## ğŸ“‚ `/programs/dex-solana/` - Main Program Directory

This directory contains the entire Solana program (smart contract) logic.

### `Cargo.toml` (Program Level)
**Purpose:** Program-specific Rust dependencies
- Defines dependencies: Anchor framework, Solana SDK, SPL Token, etc.
- Specifies program features and compilation flags
- Sets the crate type to `cdylib` for Solana deployment

### `lib.rs` - Program Entry Point
**Purpose:** Main program module that exposes all public instructions
- **Declares program ID:** `C5x9ZuZETH3RA8QEU83xhFjCkGjPWVVzrWmkV4kS7pmR`
- **Defines public instruction handlers:** All functions users can call (swap, commission_swap, proxy_swap, etc.)
- **Organizes modules:** Links together adapters, instructions, state, utils, etc.
- **Exports key functionality:** Makes modules accessible to external callers

**Key Instructions Exposed:**
- `swap()` - Basic token swap
- `commission_swap()` - Swap with commission fee
- `proxy_swap()` - Swap on behalf of another user
- `swap_v3()` - Latest version with platform fees
- Limit order functions: `place_order()`, `fill_order()`, `cancel_order()`
- Global config management: `init_global_config()`, `set_admin()`, `pause()`, etc.

---

## ğŸ“‚ `/programs/dex-solana/src/adapters/` - DEX Integrations

### **Purpose:**
The adapters directory contains **integration code for 40+ different DEX protocols**. Each adapter acts as a **translator** between the Router's unified interface and each DEX's specific implementation.

### **Why Do We Need Adapters?**
Different DEXs on Solana have different:
- Account structures
- Instruction formats
- Calculation methods
- Token handling approaches

Adapters **abstract away these differences** so the router can treat all DEXs uniformly.

### **How Adapters Work:**
Each adapter implements the `DexProcessor` trait (defined in `common.rs`):
```rust
pub trait DexProcessor {
    fn before_invoke(&self, account_infos: &[AccountInfo]) -> Result<u64>;
    fn after_invoke(&self, account_infos: &[AccountInfo], hop: usize, owner_seeds: Option<&[&[&[u8]]]>) -> Result<u64>;
}
```

### **Key Adapter Files:**

#### `common.rs`
- Defines the `DexProcessor` trait interface
- Provides shared validation logic (`before_check`, `after_check`)
- Implements common account verification
- Manages token account state tracking across swaps

#### Individual DEX Adapters:
- **`raydium.rs`** - Raydium AMM integration (largest Solana DEX)
- **`whirlpool.rs`** - Orca Whirlpool concentrated liquidity pools
- **`meteora.rs`** - Meteora DLMM (Dynamic Liquidity Market Maker)
- **`openbookv2.rs`** - OpenBook orderbook DEX
- **`phoenix.rs`** - Phoenix orderbook DEX
- **`pumpfun.rs`** - Pump.fun meme token launchpad
- **`sanctum.rs`** - Sanctum liquid staking swaps
- **`lifinity.rs`** - Lifinity proactive market maker
- **`pancake_swap_v3.rs`** - PancakeSwap V3 integration
- ... and 30+ more DEX protocols

Each adapter file typically contains:
1. Account structure definitions specific to that DEX
2. Swap instruction building logic
3. Token amount calculation methods
4. CPI (Cross-Program Invocation) call handling

### **Example: How an Adapter Works**
When a user wants to swap USDC â†’ SOL using Raydium:
1. Router receives the swap request
2. Identifies `Dex::RaydiumSwap` from the route
3. Calls `raydium.rs` adapter
4. Adapter prepares Raydium-specific accounts and instructions
5. Executes CPI call to Raydium program
6. Returns swap results back to router

---

## ğŸ“‚ `/programs/dex-solana/src/instructions/` - Instruction Handlers

### **Purpose:**
Contains the **business logic** for all program instructions. These are the functions that get called when users interact with the program.

### **Key Instruction Files:**

#### `common_swap.rs` â­ **MOST IMPORTANT**
**Core data structures and swap logic:**
- Defines `Dex` enum (77 DEX types)
- Defines `Route` struct (DEX list + weights)
- Defines `SwapArgs` struct (complete swap parameters with 2-level splitting)
- Defines `HopAccounts` (tracks multi-hop account state)
- Contains the main swap distribution logic

#### `swap.rs`
**Basic swap instruction:**
- Implements `swap_handler()` - the primary swap entry point
- Validates user accounts and inputs
- Calls routing execution logic
- Emits swap events

#### `commission_swap.rs`
**Commission-based swaps:**
- Handles swaps where a referrer earns commission
- Calculates and distributes commission fees
- Separate handlers for SPL tokens vs SOL

#### `proxy_swap.rs`
**Delegated swaps:**
- Allows third-party to execute swaps on user's behalf
- Used by dApps/wallets to swap for users
- Maintains proper authority checks

#### `swap_v3.rs`
**Latest swap version:**
- Combines commission + platform fees
- More efficient fee handling
- Supports "Take on Commission" (TOC) and "Take on Buy" (TOB) models

#### `commission_v3.rs`
**V3 commission logic:**
- Advanced fee calculation
- Multi-tier fee structures
- Optimized gas costs

#### `from_swap.rs`
**Bridge integration:**
- Handles swaps after cross-chain bridges
- Integrates with Wormhole/other bridges
- Processes logged swap events from bridges

#### `platform_fee_*.rs` files
**Platform fee management:**
- Calculate platform fees (protocol revenue)
- Distribute fees to treasury
- Support different fee models

#### `commission_wrap_unwrap.rs`
**SOL wrapping/unwrapping:**
- Converts SOL â†” wSOL (wrapped SOL)
- Handles commission on wrap/unwrap operations
- Required since SPL Token standard needs wrapped SOL

---

## ğŸ“‚ `/programs/dex-solana/src/state/` - State Definitions

### **Purpose:**
Defines **on-chain account structures** that persist data on the Solana blockchain.

### **Key State Files:**

#### `config.rs`
**Global program configuration:**
```rust
pub struct GlobalConfig {
    pub bump: u8,                    // PDA bump seed
    pub admin: Pubkey,               // Program administrator
    pub resolvers: [Pubkey; 5],      // Authorized order resolvers
    pub trade_fee: u64,              // Base trading fee
    pub paused: bool,                // Emergency pause switch
    pub fee_multiplier: u8,          // Fee scaling factor
    pub padding: [u8; 127],          // Reserved for upgrades
}
```
**Purpose:**
- Stores global program settings
- Controls who can manage the program
- Manages fee parameters
- Supports emergency pause functionality

#### `order.rs`
**Limit order state:**
```rust
pub struct Order {
    pub user: Pubkey,                   // Order owner
    pub making_amount: u64,             // Amount user is selling
    pub expect_taking_amount: u64,      // Expected receive amount
    pub min_return_amount: u64,         // Minimum acceptable amount
    pub deadline: i64,                  // Order expiration
    // ... more fields
}
```
**Purpose:**
- Stores limit order details
- Tracks order status (open, filled, cancelled)
- Manages order escrow accounts
- Enables off-chain orderbook matching

#### `event.rs`
**Event definitions:**
- Defines event structures emitted by the program
- Used for indexing and tracking swap history
- Includes SwapEvent, OrderEvent, FeeEvent, etc.
- Enables building transaction history dashboards

---

## ğŸ“‚ `/programs/dex-solana/src/utils/` - Utility Functions

### **Purpose:**
Provides **reusable helper functions** used across the program. These are common operations that don't fit into a specific instruction or adapter.

### **Key Utility Files:**

#### `swap.rs`
**Swap calculation utilities:**
- Token amount calculations
- Slippage validation
- Route optimization helpers
- Multi-hop swap logic

#### `token.rs`
**Token operation helpers:**
- SPL Token transfers
- Account creation
- Balance checking
- Token account validation
- Wrapping/unwrapping SOL

#### `fee.rs`
**Fee calculation utilities:**
- Commission calculations
- Platform fee math
- Fee distribution logic
- Rounding and precision handling

#### `logging.rs`
**Logging and events:**
- Event emission helpers
- Debug logging macros
- Transaction logging
- Error reporting utilities

---

## ğŸ“‚ `/tests/` - Test Suite

### **Purpose:**
Contains **integration tests** and **unit tests** for the program.

**Typical test files:**
- `swap.test.ts` - Tests basic swap functionality
- `commission.test.ts` - Tests commission features
- `limit_order.test.ts` - Tests orderbook functionality
- `multi_hop.test.ts` - Tests complex routing scenarios

**What tests do:**
- Deploy program to local validator
- Create mock token accounts
- Execute swap transactions
- Verify expected outcomes
- Test edge cases and error conditions

---

## ğŸ”„ How All Modules Work Together

### **Example: USDC â†’ SOL Swap Flow**

1. **User calls `swap()` in `lib.rs`**
   - Passes `SwapArgs` with routing information
   - Specifies amount, slippage, route

2. **`lib.rs` delegates to `swap.rs` instruction handler**
   - `swap_handler()` validates inputs
   - Checks user accounts and balances

3. **`swap.rs` uses `common_swap.rs` logic**
   - Parses route from `SwapArgs`
   - Identifies `Dex::RaydiumSwap` (60%) + `Dex::Whirlpool` (40%)
   - Splits input amount: 600 USDC + 400 USDC

4. **For each DEX, calls corresponding adapter:**
   - **Raydium adapter (`raydium.rs`):**
     - Prepares Raydium-specific accounts
     - Builds swap instruction
     - Executes CPI to Raydium program
     - Returns ~0.588 SOL
   
   - **Whirlpool adapter (`whirlpool.rs`):**
     - Prepares Whirlpool-specific accounts
     - Builds swap instruction
     - Executes CPI to Whirlpool program
     - Returns ~0.392 SOL

5. **Utils helpers assist throughout:**
   - `token.rs` - Transfers tokens
   - `fee.rs` - Calculates fees
   - `swap.rs` - Validates slippage
   - `logging.rs` - Emits swap event

6. **State updated:**
   - Swap event logged in `event.rs`
   - User receives ~0.98 SOL (minus fees)
   - Transaction completes successfully

---

## ğŸ“Š Module Dependency Graph

```
lib.rs (Entry Point)
    â”‚
    â”œâ”€â”€â”€ instructions/ â”€â”€â”€â”€â”
    â”‚         â”‚             â”‚
    â”‚         â””â”€â”€â”€ common_swap.rs (Core Data Structures)
    â”‚                        â”‚
    â”œâ”€â”€â”€ adapters/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚    (40+ DEX integrations)
    â”‚                        â”‚
    â”œâ”€â”€â”€ state/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚    (On-chain accounts) â”‚
    â”‚                        â”‚
    â””â”€â”€â”€ utils/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         (Helper functions)
```

---

## ğŸ¯ Key Takeaways

1. **`adapters/`** = "How to talk to each DEX"
   - Each file handles one DEX protocol
   - Translates router commands to DEX-specific calls

2. **`instructions/`** = "What users can do"
   - Each file implements one type of operation
   - Contains business logic and validation

3. **`state/`** = "What data we store on-chain"
   - Persistent account structures
   - Configuration and order data

4. **`utils/`** = "Shared helper tools"
   - Reusable functions across the program
   - Token operations, math, logging

5. **`lib.rs`** = "Main entrance"
   - Exposes all public functions
   - Routes calls to appropriate handlers

---

## ğŸš€ Understanding the Architecture Benefits

### **Why This Structure?**

1. **Modularity:** Each adapter is independent - can add new DEXs without touching existing code
2. **Maintainability:** Clear separation of concerns - swap logic â‰  DEX integration â‰  state management
3. **Testability:** Can test each module in isolation
4. **Scalability:** Easy to add new features (new instructions) or DEXs (new adapters)
5. **Code Reuse:** Utils are shared across all instructions and adapters

### **Design Pattern: Adapter Pattern**
The adapter directory implements the classic **Adapter Design Pattern**:
- **Problem:** 40+ DEXs with different interfaces
- **Solution:** Create adapter layer that converts router's unified interface to each DEX's specific interface
- **Benefit:** Router code doesn't need to know about DEX-specific details

---

*Generated: 2025-10-13*  
*For: DEX-Router-Solana-V1 Understanding*

